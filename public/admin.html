<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>

    <style>
        /* BASE STYLE */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: sans-serif; }
        [x-cloak] { display: none !important; }
        
        /* THEME COLOR */
        .gjs-one-bg { background-color: #1f2937; } /* Gray-800 */
        .gjs-two-color { color: #f3f4f6; }
        .gjs-three-bg { background-color: #111827; color: white; }
        .gjs-four-color, .gjs-four-color-h:hover { color: #60a5fa; }

        /* ============================================================
           LOGIKA TOGGLE: SIMPLE VS ADVANCED MODE
           ============================================================ */
        
        /* Jika body punya class 'simple-mode', sembunyikan fitur rumit */
        
        /* 1. Sembunyikan Class Manager (Input Classes) */
        body.simple-mode .gjs-pn-views-container .gjs-clm-tags { display: none !important; }
        
        /* 2. Sembunyikan State Manager (Hover, Active, Focus) */
        body.simple-mode .gjs-pn-views-container .gjs-sm-header { display: none !important; }
        
        /* 3. Sembunyikan Layer Manager (Tree View yang rumit) */
        /* Kita biarkan Tab-nya ada, tapi konten detailnya disederhanakan jika perlu.
           Tapi biasanya Class & State adalah yang paling membingungkan pemula. */

        /* 4. Toolbar Rich Text (Biar muncul di atas) */
        .gjs-rte-toolbar { top: -45px !important; border-radius: 4px; border: 1px solid #374151; }

        /* Tweak UI Umum */
        .gjs-cv-canvas { width: 100%; height: 100%; top: 0; }
        .gjs-pn-panel { position: relative; }
    </style>
</head>

<body class="bg-gray-900 text-white" x-data="app()" :class="editorMode === 'simple' ? 'simple-mode' : ''">

    <div x-show="!isLoggedIn" x-cloak class="fixed inset-0 z-[9999] flex items-center justify-center bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-xl w-96 border border-gray-700 shadow-2xl">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-500">Builder Login</h1>
            <form @submit.prevent="login">
                <input type="password" x-model="auth.password" placeholder="Password Admin" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 mb-4 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">MASUK</button>
            </form>
        </div>
    </div>

    <div x-show="isLoggedIn" x-cloak class="flex flex-col h-full">
        
        <div class="h-14 bg-gray-900 border-b border-gray-700 flex justify-between items-center px-4 relative z-40 shadow-md">
            
            <div class="flex items-center gap-4">
                <div class="flex flex-col leading-tight">
                    <span class="font-bold text-lg text-blue-500">LandingPro</span>
                    <button @click="toggleMode" class="text-[10px] font-bold px-2 py-0.5 rounded-full border transition-colors flex items-center gap-1 w-fit"
                        :class="editorMode === 'simple' ? 'bg-green-900/30 border-green-600 text-green-400 hover:bg-green-900/50' : 'bg-red-900/30 border-red-600 text-red-400 hover:bg-red-900/50'">
                        <span x-text="editorMode === 'simple' ? 'üòä SIMPLE' : '‚ö° ADVANCED'"></span>
                    </button>
                </div>
                
                <div class="h-8 w-px bg-gray-700 mx-2"></div>

                <div class="flex items-center bg-gray-800 rounded border border-gray-600 overflow-hidden">
                    <span class="px-2 text-xs text-gray-500">/</span>
                    <input x-model="page.slug" placeholder="slug" class="bg-transparent text-sm p-1 outline-none w-28 text-white placeholder-gray-600">
                </div>
                <input x-model="page.title" placeholder="Judul Halaman" class="bg-gray-800 border border-gray-600 text-sm p-1 rounded w-40 outline-none focus:border-blue-500">
            </div>

            <div class="flex gap-2">
                <button @click="modal='product'" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1.5 rounded text-xs font-bold transition">üì¶ Produk</button>
                <button @click="openReport" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded text-xs font-bold transition">üìä Data</button>
                <button @click="modal='settings'" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-xs font-bold transition">‚öôÔ∏è API</button>
                <button @click="setAsHomepage" class="bg-purple-600 hover:bg-purple-700 px-3 py-1.5 rounded text-xs font-bold transition" title="Set Home">üè†</button>
                
                <div class="w-px bg-gray-700 mx-1"></div>

                <button @click="savePage" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded text-xs font-bold flex gap-2 shadow-lg hover:-translate-y-0.5 transition transform">
                    <span x-show="loading" class="animate-spin">‚è≥</span><span>SIMPAN</span>
                </button>
                <button @click="previewPage" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-xs font-bold transition">üëÅÔ∏è</button>
                <button @click="logout" class="text-red-400 hover:text-red-300 text-xs px-2 font-bold">Keluar</button>
            </div>
        </div>

        <div id="gjs" class="h-[calc(100%-3.5rem)] bg-gray-800"></div>

    </div>

    <div x-show="modal==='product'" x-cloak class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white text-gray-800 w-full max-w-4xl h-[85vh] rounded-xl flex overflow-hidden shadow-2xl">
            <div class="w-48 bg-gray-50 border-r p-4 flex flex-col gap-2">
                <button @click="tab='variants'" :class="tab=='variants'?'bg-blue-100 text-blue-700':''" class="text-left px-4 py-2 rounded text-sm font-bold transition">1. Varian</button>
                <button @click="tab='bump'" :class="tab=='bump'?'bg-blue-100 text-blue-700':''" class="text-left px-4 py-2 rounded text-sm font-bold transition">2. Bump</button>
                <button @click="tab='coupons'" :class="tab=='coupons'?'bg-blue-100 text-blue-700':''" class="text-left px-4 py-2 rounded text-sm font-bold transition">3. Kupon</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Konfigurasi Produk</h2><button @click="modal=null" class="text-2xl text-red-500 font-bold hover:scale-110 transition">&times;</button></div>
                <div x-show="tab=='variants'">
                    <button @click="addVariant" class="bg-blue-600 text-white text-xs px-3 py-1 rounded mb-4 font-bold">+ Tambah Paket</button>
                    <template x-for="(v, i) in page.config.variants"><div class="border p-3 mb-2 rounded bg-gray-50 grid grid-cols-12 gap-2 items-center hover:shadow-sm transition"><div class="col-span-4"><input x-model="v.name" placeholder="Nama Paket" class="border p-2 w-full text-sm rounded"></div><div class="col-span-3"><input x-model="v.price" type="number" placeholder="Harga" class="border p-2 w-full text-sm rounded"></div><div class="col-span-4"><input x-model="v.desc" placeholder="Deskripsi" class="border p-2 w-full text-sm rounded"></div><button @click="page.config.variants.splice(i,1)" class="col-span-1 text-red-500 font-bold hover:bg-red-100 rounded p-1">&times;</button></div></template>
                </div>
                <div x-show="tab=='bump'" class="space-y-4">
                    <label class="flex gap-2 p-3 border rounded bg-yellow-50 cursor-pointer"><input type="checkbox" x-model="page.config.order_bump.active" class="accent-orange-500"><span class="font-bold">Aktifkan Order Bump</span></label>
                    <div x-show="page.config.order_bump.active" class="grid gap-3 p-4 border rounded"><input x-model="page.config.order_bump.product_name" placeholder="Nama Produk Tambahan" class="border p-2 w-full rounded"><input x-model="page.config.order_bump.price" type="number" placeholder="Harga Tambahan" class="border p-2 w-full rounded"><textarea x-model="page.config.order_bump.description" placeholder="Kalimat Penawaran" class="border p-2 w-full h-20 rounded"></textarea></div>
                </div>
                <div x-show="tab=='coupons'">
                    <button @click="addCoupon" class="bg-green-600 text-white text-xs px-3 py-1 rounded mb-4 font-bold">+ Kupon Baru</button>
                    <template x-for="(c, i) in page.config.coupons"><div class="flex gap-2 mb-2 items-center"><input x-model="c.code" placeholder="KODE" class="border p-2 uppercase w-1/3 rounded font-mono"><select x-model="c.type" class="border p-2 rounded bg-white"><option value="percent">%</option><option value="fixed">Rp</option></select><input x-model="c.value" type="number" class="border p-2 w-1/3 rounded"><button @click="page.config.coupons.splice(i,1)" class="text-red-500 font-bold px-3 hover:bg-red-100 rounded">&times;</button></div></template>
                </div>
            </div>
        </div>
    </div>

    <div x-show="modal==='settings'" x-cloak class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"><div class="bg-white text-gray-800 w-96 p-6 rounded-lg shadow-xl"><h2 class="font-bold mb-4">API Settings</h2><select x-model="cred.provider" class="w-full border p-2 mb-2 rounded"><option value="midtrans">Midtrans</option><option value="cloudinary">Cloudinary</option></select><textarea x-model="cred.data" class="w-full border p-2 h-32 text-xs font-mono mb-4 rounded bg-gray-50" placeholder='{"server_key":"..."}'></textarea><div class="flex justify-end gap-2"><button @click="modal=null" class="text-sm px-3">Batal</button><button @click="saveCreds" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">Simpan</button></div></div></div>
    <div x-show="modal==='report'" x-cloak class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"><div class="bg-gray-50 text-gray-800 w-full max-w-5xl h-[90vh] rounded-xl flex flex-col overflow-hidden shadow-2xl"><div class="bg-white p-4 border-b flex justify-between"><div><h2 class="text-xl font-bold">Laporan Penjualan</h2></div><button @click="modal=null" class="text-red-500 font-bold text-2xl">&times;</button></div><div class="flex-grow p-6 overflow-y-auto"><div class="grid grid-cols-4 gap-4 mb-6"><div class="bg-white p-4 rounded shadow border-l-4 border-green-500"><div class="text-xs text-gray-500 font-bold uppercase">Omzet (Paid)</div><div class="text-xl font-bold text-green-600">Rp <span x-text="(report.stats.total_revenue||0).toLocaleString()"></span></div></div><div class="bg-white p-4 rounded shadow border-l-4 border-gray-500"><div class="text-xs text-gray-500 font-bold uppercase">Total Order</div><div class="text-xl font-bold" x-text="report.stats.total_orders||0"></div></div><div class="bg-white p-4 rounded shadow border-l-4 border-blue-500"><div class="text-xs text-gray-500 font-bold uppercase">Sukses</div><div class="text-xl font-bold text-blue-600" x-text="report.stats.success_count||0"></div></div><div class="bg-white p-4 rounded shadow border-l-4 border-orange-500"><div class="text-xs text-gray-500 font-bold uppercase">Pending</div><div class="text-xl font-bold text-orange-500" x-text="report.stats.pending_count||0"></div></div></div><div class="grid grid-cols-3 gap-6"><div class="bg-white p-4 rounded shadow col-span-1 h-64 flex flex-col items-center"><h3 class="font-bold text-sm mb-2">Rasio Status</h3><canvas id="chart"></canvas></div><div class="bg-white p-4 rounded shadow col-span-2 overflow-x-auto"><h3 class="font-bold text-sm mb-4">10 Transaksi Terakhir</h3><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Tgl</th><th class="p-2">Cust</th><th class="p-2">Total</th><th class="p-2">Status</th></tr></thead><tbody><template x-for="t in report.recent_orders"><tr class="border-b hover:bg-gray-50"><td class="p-2 text-xs" x-text="new Date(t.created_at).toLocaleDateString()"></td><td class="p-2"><div class="font-bold" x-text="safe(t.customer_info).name"></div><div class="text-xs text-blue-600" x-text="safe(t.customer_info).item"></div></td><td class="p-2 font-bold">Rp <span x-text="t.amount.toLocaleString()"></span></td><td class="p-2"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide" :class="['settlement','capture'].includes(t.status)?'bg-green-100 text-green-700':(t.status=='pending'?'bg-orange-100 text-orange-700':'bg-red-100 text-red-700')" x-text="t.status"></span></td></tr></template></tbody></table></div></div></div></div></div>

    <script>
        function app() {
            return {
                isLoggedIn: false, loading: false, modal: null, tab: 'variants', 
                editorMode: 'simple', // DEFAULT: Simple Mode
                
                auth: {password:''},
                page: { slug:'', title:'', config: {variants:[], coupons:[], order_bump:{active:false}} },
                cred: {provider:'midtrans', data:''}, report: {stats:{}, recent_orders:[]}, chart: null,

                init() { 
                    const p = localStorage.getItem('admin_pass'); 
                    // Load last mode preference
                    const savedMode = localStorage.getItem('editor_mode');
                    if(savedMode) this.editorMode = savedMode;

                    if(p) { this.auth.password=p; this.verify(); } 
                },

                // Toggle Function
                toggleMode() {
                    this.editorMode = this.editorMode === 'simple' ? 'advanced' : 'simple';
                    localStorage.setItem('editor_mode', this.editorMode);
                },

                async verify() { try { const r=await fetch('/api/login',{method:'POST',body:JSON.stringify({password:this.auth.password})}); if((await r.json()).success) { this.isLoggedIn=true; localStorage.setItem('admin_pass',this.auth.password); this.initGrapes(); } } catch(e){} },
                async login() { if(this.auth.password) await this.verify(); },
                logout() { this.isLoggedIn=false; localStorage.removeItem('admin_pass'); location.reload(); },

                // Helper Functions
                addVariant(){ this.page.config.variants.push({id:Date.now(),name:'',price:0,desc:''}) },
                addCoupon(){ this.page.config.coupons.push({code:'',type:'percent',value:0}) },
                
                async saveCreds() { try { await fetch('/api/admin/credentials',{method:'POST',headers:{'Authorization':this.auth.password},body:JSON.stringify({provider:this.cred.provider,data:JSON.parse(this.cred.data)})}); alert('API Key Tersimpan!'); this.modal=null; } catch(e){ alert('JSON Error'); } },
                async savePage() { if(!this.page.slug) return alert('Isi Slug!'); this.loading=true; await fetch('/api/admin/pages',{method:'POST',headers:{'Authorization':this.auth.password},body:JSON.stringify({slug:this.page.slug, title:this.page.title, html:editor.getHtml(), css:editor.getCss(), product_config:this.page.config})}); this.loading=false; alert('Berhasil Disimpan!'); },
                async setAsHomepage() { if(confirm('Jadikan Halaman Utama?')) await fetch('/api/admin/set-homepage',{method:'POST',headers:{'Authorization':this.auth.password},body:JSON.stringify({slug:this.page.slug})}); alert('Homepage Berubah!'); },
                previewPage() { if(this.page.slug) window.open('/'+this.page.slug,'_blank'); },
                safe(s) { try{return JSON.parse(s)}catch(e){return {name:'-',item:'-'}} },
                async openReport() { if(!this.page.slug) return alert('Load page dulu'); const r = await fetch('/api/admin/stats/'+this.page.slug); this.report = await r.json(); this.modal='report'; setTimeout(()=>{ if(this.chart) this.chart.destroy(); this.chart = new Chart(document.getElementById('chart'), { type:'doughnut', data: { labels:['Sukses','Pending'], datasets:[{data:[this.report.stats.success_count||0, this.report.stats.pending_count||0], backgroundColor:['#2563eb','#f97316']}] } }); }, 200); },

                initGrapes() {
                    setTimeout(() => {
                        window.editor = grapesjs.init({
                            container: '#gjs',
                            height: '100%',
                            storageManager: false,
                            // Kita load semua plugin, tapi CSS yang akan menyembunyikan fitur di mode 'simple'
                            plugins: ['gjs-preset-webpage'],
                            
                            styleManager: {
                                sectors: [
                                    {
                                        name: 'Teks & Font', open: false,
                                        buildProps: ['font-family', 'font-size', 'font-weight', 'line-height', 'color', 'text-align'],
                                        properties: [{ name: 'Font', property: 'font-family', defaults: 'Arial, Helvetica, sans-serif', list: [{ value: 'Arial, Helvetica, sans-serif', name: 'Arial' }, { value: "'Roboto', sans-serif", name: 'Roboto' }, { value: "'Open Sans', sans-serif", name: 'Open Sans' }] }]
                                    },
                                    { name: 'Tampilan', open: false, buildProps: ['background-color', 'border', 'border-radius', 'box-shadow', 'opacity'] },
                                    { name: 'Dimensi', open: false, buildProps: ['width', 'height', 'padding', 'margin'] },
                                    
                                    // Sektor Advanced (Akan tetap ada untuk mode Advanced)
                                    { name: 'Layout (Advanced)', open: false, buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'position'] },
                                    { name: 'Extra', open: false, buildProps: ['transition', 'perspective', 'transform'] }
                                ]
                            },
                            
                            assetManager: { upload: false, uploadText: 'Drop file di sini' },
                            blockManager: { appendTo: '#blocks' }
                        });

                        // Upload Handler
                        editor.on('asset:upload', async (obj) => {
                            const f = obj.dataTransfer?obj.dataTransfer.files[0]:obj.target.files[0];
                            const r = new FileReader(); r.readAsDataURL(f);
                            r.onload = async () => { const rs = await fetch('/api/admin/upload-image',{method:'POST',body:JSON.stringify({image:r.result,filename:f.name.split('.')[0]})}); const d=await rs.json(); if(d.success) editor.AssetManager.add(d.url); else alert('Gagal Upload'); }
                        });

                        // Load Page Handler
                        document.querySelector('input[placeholder="slug"]').addEventListener('blur', async (e)=>{
                            if(!e.target.value)return;
                            const r = await fetch('/api/admin/pages/'+e.target.value); const d=await r.json();
                            if(d.id) { this.page.title=d.title; this.page.config=d.product_config_json||this.page.config; editor.setComponents(d.html_content); editor.setStyle(d.css_content); }
                        });

                        this.registerWidget();
                    }, 200);
                },

                // Widget Checkout
                registerWidget() {
                    editor.Blocks.add('checkout-pro', { label:'üõí Checkout Pro', category:'PRO WIDGETS', attributes:{class:'fa fa-shopping-cart'}, content: `
                    <div x-data="checkoutWidget()" class="max-w-md mx-auto bg-white border rounded-xl shadow-lg p-6 mt-4 font-sans">
                        <div class="bg-blue-600 text-white p-3 -mx-6 -mt-6 mb-4 rounded-t-xl text-center font-bold">FORM PEMESANAN</div>
                        <div class="mb-4 space-y-2"><template x-for="v in variants"><div @click="sel=v" class="border p-3 rounded cursor-pointer flex justify-between hover:bg-blue-50" :class="sel.id==v.id?'border-blue-600 bg-blue-50':'border-gray-200'"><div><div class="font-bold text-sm" x-text="v.name"></div><div class="text-xs text-gray-500" x-text="v.desc"></div></div><div class="font-bold text-blue-600">Rp <span x-text="(v.price).toLocaleString()"></span></div></div></template></div>
                        <div class="space-y-3 mb-4"><input x-model="f.name" class="w-full border p-2 rounded text-sm" placeholder="Nama Lengkap"><input x-model="f.wa" class="w-full border p-2 rounded text-sm" placeholder="WhatsApp"></div>
                        <template x-if="bump.active"><div class="mb-4 border-2 border-dashed border-red-400 bg-red-50 p-3 rounded relative"><div class="absolute -top-2 right-2 bg-red-600 text-white text-[10px] px-2 rounded font-bold">PROMO</div><label class="flex gap-2 cursor-pointer"><input type="checkbox" x-model="withBump" class="w-4 h-4"><div class="text-sm font-bold text-gray-800">Ya, Tambah <span x-text="bump.product_name"></span> (+Rp <span x-text="(bump.price).toLocaleString()"></span>)</div></label></div></template>
                        <div class="flex gap-2 mb-2"><input x-model="code" class="border p-2 w-full rounded text-sm uppercase" placeholder="KODE PROMO"><button @click="check" class="bg-gray-800 text-white px-3 rounded text-xs">CEK</button></div>
                        <div x-show="msg" class="text-xs mb-2 font-bold" :class="valid?'text-green-600':'text-red-500'" x-text="msg"></div>
                        <div class="border-t pt-2 text-sm space-y-1"><div class="flex justify-between"><span>Subtotal</span><span x-text="(sel.price||0).toLocaleString()"></span></div><div x-show="withBump" class="flex justify-between text-red-600"><span>Bump</span><span x-text="(bump.price).toLocaleString()"></span></div><div x-show="disc>0" class="flex justify-between text-green-600"><span>Diskon</span><span x-text="disc.toLocaleString()"></span></div><div class="flex justify-between font-bold text-lg border-t pt-2"><span>Total</span><span class="text-blue-700">Rp <span x-text="total.toLocaleString()"></span></span></div></div>
                        <button @click="pay" :disabled="loading||!sel.id" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded font-bold mt-4 shadow disabled:opacity-50"><span x-text="loading?'Memproses...':'BELI SEKARANG'"></span></button>
                        <script>
                            function checkoutWidget(){return{
                                variants:window.PRODUCT_VARIANTS||[], bump:window.ORDER_BUMP||{active:false}, sel:{}, f:{name:'',wa:''}, withBump:false, code:'', valid:false, msg:'', disc:0, appC:null, loading:false,
                                init(){if(this.variants.length>0)this.sel=this.variants[0]; if(!document.getElementById('snap')){let s=document.createElement('script');s.id='snap';s.src='https://app.sandbox.midtrans.com/snap/snap.js';s.setAttribute('data-client-key','DUMMY');document.head.appendChild(s);}},
                                get total(){let t=(this.sel.price||0);if(this.withBump&&this.bump.active)t+=this.bump.price;if(this.appC){if(this.appC.type=='percent')this.disc=Math.round(t*this.appC.value/100);else this.disc=this.appC.value;}else this.disc=0; t-=this.disc; return t<0?0:t;},
                                async check(){if(!this.code)return;const r=await fetch('/api/check-coupon',{method:'POST',body:JSON.stringify({page_id:window.PAGE_ID,code:this.code})});const d=await r.json();this.msg=d.message;if(d.success){this.valid=true;this.appC=d;}else{this.valid=false;this.disc=0;this.appC=null;}},
                                async pay(){if(!this.f.name||!this.f.wa)return alert('Isi Data');this.loading=true;try{const r=await fetch('/api/checkout',{method:'POST',body:JSON.stringify({page_id:window.PAGE_ID,provider:'midtrans',variant_id:this.sel.id,with_bump:this.withBump,coupon_code:this.valid?this.code:null,customer:{name:this.f.name,whatsapp:this.f.wa}})});const d=await r.json();if(d.token&&window.snap)window.snap.pay(d.token);else if(d.redirect_url)window.location.href=d.redirect_url;else alert(d.message||'Gagal');}catch(e){alert('Error');}this.loading=false;}
                            }}
                        <\/script>
                    </div>` });
                }
            }
        }
    </script>
</body>
</html>
