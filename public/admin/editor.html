<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder Pro - Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-blocks-basic"></script>
    <script src="https://unpkg.com/grapesjs-plugin-forms"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- STYLE SAMA SEPERTI SEBELUMNYA (DIPERSINGKAT UNTUK FOKUS KONTEKS) --- */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #f8fafc; color: #334155; }
        [x-cloak] { display: none !important; }
        .gjs-pn-top-panel, .gjs-pn-views-container, .gjs-pn-views, .gjs-pn-panels, .gjs-pn-buttons { display: none !important; }
        .gjs-cv-canvas { width: 100%; height: 100%; top: 0 !important; background-color: #f1f5f9; }
        .gjs-frame-wrapper { margin: 0 auto; background: white; box-shadow: 0 10px 40px -10px rgba(30, 58, 138, 0.15); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .panel-tabs { display: flex; background: white; border-bottom: 1px solid #e0f2fe; }
        .panel-tabs button { flex: 1; padding: 14px; color: #64748b; position: relative; transition: all 0.2s; font-size: 18px; }
        .panel-tabs button.active { color: #2563eb; background: #eff6ff; }
        .panel-tabs button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background: #2563eb; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>

<body x-data="editorApp()">

    <header class="h-14 bg-white border-b border-blue-100 flex justify-between items-center px-4 z-50 relative shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <a href="/admin/pages" class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-blue-50 text-slate-500 hover:text-blue-600 transition">
                <i class="ph ph-arrow-left text-lg"></i> <span class="text-xs font-bold uppercase">Back</span>
            </a>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex items-center bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5">
                <span class="text-slate-400 text-xs mr-2 font-mono font-bold">/</span>
                <input x-model="page.slug" class="bg-transparent text-sm font-bold text-slate-700 outline-none w-32" placeholder="slug-halaman">
            </div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-white rounded-xl border border-slate-200 p-1 shadow-sm">
            <button @click="setDevice('desktop')" :class="device=='desktop' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'" class="p-2 rounded-lg transition"><i class="ph ph-desktop text-xl"></i></button>
            <button @click="setDevice('tablet')" :class="device=='tablet' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'" class="p-2 rounded-lg transition"><i class="ph ph-device-tablet text-xl"></i></button>
            <button @click="setDevice('mobile')" :class="device=='mobile' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'" class="p-2 rounded-lg transition"><i class="ph ph-device-mobile text-xl"></i></button>
            <div class="w-px h-5 bg-slate-200 mx-3"></div>
            <button @click="cmd('core:undo')" class="text-slate-400 hover:text-blue-600 p-2"><i class="ph ph-arrow-u-up-left text-xl"></i></button>
            <button @click="cmd('core:redo')" class="text-slate-400 hover:text-blue-600 p-2"><i class="ph ph-arrow-u-up-right text-xl"></i></button>
            <button @click="cmd('core:preview')" class="text-slate-400 hover:text-blue-600 p-2"><i class="ph ph-eye text-xl"></i></button>
        </div>

        <div class="flex items-center gap-2">
            <button @click="savePage" :disabled="loading" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-lg shadow-blue-200">
                <i x-show="loading" class="ph ph-spinner animate-spin"></i>
                <span x-text="loading ? 'Menyimpan...' : 'Simpan Halaman'"></span>
            </button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-3.5rem)] overflow-hidden">
        
        <div class="flex-1 relative bg-slate-100 flex flex-col items-center justify-center p-8 overflow-hidden">
            <div id="gjs" class="flex-1 w-full h-full shadow-xl rounded-lg overflow-hidden border border-slate-200 bg-white"></div>
        </div>

        <div class="w-[340px] bg-white border-l border-blue-100 flex flex-col z-20 shrink-0 shadow-lg">
            
            <div class="panel-tabs">
                <button @click="tab='blocks'" :class="tab=='blocks' ? 'active' : ''" title="Add"><i class="ph ph-plus-square text-2xl"></i></button>
                <button @click="tab='styles'" :class="tab=='styles' ? 'active' : ''" title="Style"><i class="ph ph-paint-brush text-2xl"></i></button>
                <button @click="tab='layers'" :class="tab=='layers' ? 'active' : ''" title="Layers"><i class="ph ph-list-dashes text-2xl"></i></button>
                <button @click="tab='settings'" :class="tab=='settings' ? 'active' : ''" title="Page Config"><i class="ph ph-gear text-2xl"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto bg-white relative custom-scroll">
                <div x-show="tab=='blocks'" id="blocks-container" class="absolute inset-0 pb-20"></div>
                
                <div x-show="tab=='styles'">
                    <div id="selectors-container" class="p-3 border-b border-gray-100"></div>
                    <div id="styles-container" class="pb-20"></div>
                </div>

                <div x-show="tab=='layers'" id="layers-container" class="absolute inset-0 pb-20"></div>

                <div x-show="tab=='settings'" class="p-5 space-y-6 pb-20">
                    
                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <div class="bg-slate-50 p-3 border-b border-slate-200"><h3 class="text-xs font-bold text-slate-600 uppercase">Produk & Harga</h3></div>
                        <div class="p-4 space-y-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipe Produk</label>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button @click="page.product_type = 'physical'" :class="page.product_type=='physical' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-1.5 rounded-md text-xs font-bold transition">Fisik (Kirim)</button>
                                    <button @click="page.product_type = 'digital'" :class="page.product_type=='digital' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-1.5 rounded-md text-xs font-bold transition">Digital</button>
                                </div>
                            </div>
                            <div x-show="page.product_type === 'physical'">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1">Berat (Gram)</label>
                                <input x-model="page.config.shipping.weight" type="number" class="w-full border border-slate-300 rounded p-2 text-xs" placeholder="1000">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 flex justify-between"><span>Varian</span> <span @click="addVariant" class="text-blue-500 cursor-pointer">+ Add</span></label>
                                <template x-for="(v, i) in page.config.variants">
                                    <div class="flex gap-1 mb-1">
                                        <input x-model="v.name" class="w-full border rounded p-1 text-xs" placeholder="Nama">
                                        <input x-model="v.price" type="number" class="w-20 border rounded p-1 text-xs" placeholder="Rp">
                                        <button @click="page.config.variants.splice(i,1)" class="text-red-400 px-1"><i class="ph ph-trash"></i></button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <div class="bg-slate-50 p-3 border-b border-slate-200"><h3 class="text-xs font-bold text-slate-600 uppercase">SEO & Metadata</h3></div>
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Judul Halaman (Browser Title)</label>
                                <input x-model="page.config.settings.seo_title" class="w-full border border-slate-300 rounded p-2 text-xs" placeholder="Jual Sepatu Murah...">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Deskripsi (Meta Desc)</label>
                                <textarea x-model="page.config.settings.seo_description" rows="2" class="w-full border border-slate-300 rounded p-2 text-xs" placeholder="Dapatkan promo terbatas..."></textarea>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Favicon URL</label>
                                <input x-model="page.config.settings.favicon" class="w-full border border-slate-300 rounded p-2 text-xs" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <div class="bg-slate-50 p-3 border-b border-slate-200"><h3 class="text-xs font-bold text-slate-600 uppercase">Pixel & Scripts</h3></div>
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-blue-600 mb-1">Facebook Pixel ID</label>
                                <input x-model="page.config.settings.fb_pixel_id" class="w-full border border-blue-200 bg-blue-50 rounded p-2 text-xs" placeholder="1234567890">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-800 mb-1">TikTok Pixel ID</label>
                                <input x-model="page.config.settings.tiktok_pixel_id" class="w-full border border-slate-300 rounded p-2 text-xs" placeholder="CXXXXXXXXX">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Custom Head HTML</label>
                                <textarea x-model="page.config.settings.custom_head" rows="3" class="w-full border border-slate-300 rounded p-2 text-xs font-mono text-slate-600" placeholder="<script>..."></textarea>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Custom Footer HTML</label>
                                <textarea x-model="page.config.settings.custom_footer" rows="3" class="w-full border border-slate-300 rounded p-2 text-xs font-mono text-slate-600" placeholder="<script>..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <div class="bg-slate-50 p-3 border-b border-slate-200"><h3 class="text-xs font-bold text-slate-600 uppercase">Koneksi API</h3></div>
                        <div class="p-4 space-y-3">
                            <select x-model="cred.provider" class="w-full border border-slate-300 rounded text-xs p-2 bg-white">
                                <option value="midtrans">Midtrans</option>
                                <option value="cloudinary">Cloudinary</option>
                            </select>
                            <textarea x-model="cred.data" class="w-full border border-slate-300 rounded text-xs p-2 font-mono h-16" placeholder='{"server_key":"..."}'></textarea>
                            <button @click="saveCreds" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-2 rounded text-xs font-bold">Simpan Key</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        function editorApp() {
            return {
                loading: false,
                device: 'desktop', 
                tab: 'blocks',
                
                // STATE DATA LENGKAP
                page: { 
                    slug: '', 
                    title: '', 
                    product_type: 'physical',
                    config: { 
                        variants:[], 
                        coupons:[], 
                        order_bump:{active:false},
                        shipping: { weight: 1000 },
                        settings: { // METADATA BARU
                            seo_title: '',
                            seo_description: '',
                            favicon: '',
                            fb_pixel_id: '',
                            tiktok_pixel_id: '',
                            custom_head: '',
                            custom_footer: ''
                        }
                    } 
                },
                cred: { provider: 'midtrans', data: '' },
                authPass: localStorage.getItem('admin_pass'),

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const slug = urlParams.get('slug');
                    if(slug) this.page.slug = slug;
                    
                    if(!this.authPass) window.location.href = '/login';
                    this.initGrapes();
                },

                setDevice(d) {
                    this.device = d;
                    if(window.editor) window.editor.setDevice(d);
                },
                cmd(c) { window.editor.runCommand(c); },
                addVariant() { this.page.config.variants.push({ id:Date.now(), name:'', price:0, desc:'' }) },
                
                async saveCreds() {
                    try {
                        await fetch('/api/admin/credentials', {
                            method: 'POST', headers: { 'Authorization': this.authPass },
                            body: JSON.stringify({ provider: this.cred.provider, data: JSON.parse(this.cred.data) })
                        });
                        alert('API Key Tersimpan!');
                    } catch(e) { alert('Format JSON Salah!'); }
                },

                async savePage() {
                    if(!this.page.slug) return alert('Slug wajib diisi!');
                    
                    // Pastikan settings object ada (untuk data lama)
                    if(!this.page.config.settings) this.page.config.settings = {};

                    this.loading = true;
                    try {
                        await fetch('/api/admin/pages', {
                            method: 'POST',
                            headers: { 'Authorization': this.authPass },
                            body: JSON.stringify({
                                slug: this.page.slug,
                                title: this.page.title,
                                product_type: this.page.product_type,
                                html: editor.getHtml(),
                                css: editor.getCss(),
                                product_config: this.page.config
                            })
                        });
                        alert('Berhasil Disimpan!');
                    } catch(e) { alert('Gagal menyimpan.'); }
                    this.loading = false;
                },

                initGrapes() {
                    setTimeout(() => {
                        window.editor = grapesjs.init({
                            container: '#gjs',
                            height: '100%',
                            fromElement: false,
                            storageManager: false,
                            plugins: ['gjs-blocks-basic', 'grapesjs-plugin-forms', 'gjs-preset-webpage'],
                            pluginsOpts: {
                                'gjs-blocks-basic': { flexGrid: true },
                                'grapesjs-plugin-forms': {},
                                'gjs-preset-webpage': { blocks: [], formsOpts: false, navbarOpts: false, countdownOpts: false }
                            },
                            deviceManager: {
                                devices: [
                                    { id: 'desktop', name: 'Desktop', width: '' },
                                    { id: 'tablet', name: 'Tablet', width: '768px', widthMedia: '992px' },
                                    { id: 'mobile', name: 'Mobile', width: '375px', widthMedia: '480px' },
                                ],
                            },
                            blockManager: { appendTo: '#blocks-container' },
                            layerManager: { appendTo: '#layers-container' },
                            selectorManager: { appendTo: '#selectors-container' },
                            styleManager: { appendTo: '#styles-container', sectors: [{ name: 'Typography', open: true, buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-align'] }, { name: 'Layout', open: false, buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'width', 'height', 'padding', 'margin'] }, { name: 'Background', open: false, buildProps: ['background-color', 'background-image'] }, { name: 'Border & Effects', open: false, buildProps: ['border', 'border-radius', 'box-shadow'] }] },
                            assetManager: { upload: '/api/admin/upload-image', uploadName: 'file', headers: { 'Authorization': this.authPass }, autoAdd: true }
                        });

                        // CUSTOM BLOCKS
                        const bm = editor.BlockManager;
                        bm.add('section', {
                            label: 'Section', category: 'Layout', attributes: { class: 'fa fa-square' },
                            content: `<section style="padding: 50px 20px; display:flex; flex-direction:column; align-items:center;"><h2 style="margin-bottom:10px;">Judul Section</h2><p>Deskripsi singkat.</p></section>`
                        });
                        bm.add('checkout-pro', {
                            label: 'Checkout Form', category: 'E-Commerce', attributes: { class: 'fa fa-shopping-cart' },
                            content: { type: 'checkout-widget', style: { padding: '20px', border: '2px dashed #3b82f6', 'background-color': '#eff6ff', 'text-align': 'center', 'border-radius': '8px' }, components: [{ tagName: 'strong', content: '[ CHECKOUT FORM ]', style: { color: '#1e40af', 'font-size': '18px' } }, { tagName: 'p', content: 'Form otomatis muncul saat live.', style: { 'font-size': '12px', color: '#64748b' } }] }
                        });

                        // LOAD DATA
                        if(this.page.slug) {
                            fetch('/api/admin/pages/'+this.page.slug).then(r=>r.json()).then(d=>{
                                if(d.id) { 
                                    this.page.title=d.title; 
                                    this.page.product_type = d.product_type || 'physical';
                                    
                                    // DEEP MERGE CONFIG
                                    this.page.config = {
                                        ...this.page.config,
                                        ...JSON.parse(d.product_config_json || '{}')
                                    };
                                    
                                    // Ensure Settings Object Exists
                                    if(!this.page.config.settings) this.page.config.settings = { seo_title: d.title };
                                    if(!this.page.config.shipping) this.page.config.shipping = { weight: 1000 };

                                    if(d.html_content) editor.setComponents(d.html_content); 
                                    if(d.css_content) editor.setStyle(d.css_content); 
                                }
                            });
                        }

                        editor.on('load', () => { editor.Canvas.getBody().style.backgroundColor = '#ffffff'; });
                    }, 100);
                }
            }
        }
    </script>
</body>
</html>
