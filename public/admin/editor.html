<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Pro - LandingBuilder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs@0.21.2/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs@0.21.2/dist/grapes.min.js"></script>
    
    <script src="https://unpkg.com/grapesjs-blocks-basic@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-plugin-forms@2.0.5"></script>
    <script src="https://unpkg.com/grapesjs-component-countdown@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-custom-code@1.0.1"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- UI RESET --- */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #ffffff; color: #1e293b; }
        [x-cloak] { display: none !important; }
        .gjs-pn-top-panel, .gjs-pn-views-container, .gjs-pn-views, .gjs-pn-panels, .gjs-pn-buttons { display: none !important; }
        .gjs-cv-canvas { width: 100%; height: 100%; top: 0 !important; background-color: #f1f5f9; }
        
        /* --- PANEL --- */
        .panel-tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .panel-tabs button { flex: 1; padding: 14px; color: #64748b; font-size: 20px; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .panel-tabs button.active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
        
        /* Block Manager Grid */
        .gjs-blocks-c { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; }
        .gjs-block { 
            width: 100% !important; min-height: auto !important; padding: 15px 5px !important; margin: 0 !important;
            background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: grab; transition: all 0.2s;
        }
        .gjs-block:hover { border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 5px 10px rgba(37, 99, 235, 0.1); color: #2563eb; }
        .gjs-block-label { font-size: 10px; font-weight: 700; text-align: center; margin-top: 4px; }
        .gjs-block svg, .gjs-block i { font-size: 24px; width: 24px; height: 24px; fill: currentColor; }
        
        /* Category Styles */
        .gjs-block-category .gjs-title { background: #f1f5f9; padding: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; color: #475569; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; cursor: pointer; }

        /* Inputs */
        .gjs-field { border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; background: white; }
        .gjs-field input, .gjs-field select { font-size: 11px; width: 100%; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>

<body x-data="editorApp()">

    <header class="h-14 bg-white border-b border-gray-200 flex justify-between items-center px-4 z-50 relative shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="/admin/pages" class="text-slate-500 hover:text-blue-600 transition flex items-center gap-2 text-xs font-bold uppercase"><i class="ph ph-arrow-left text-lg"></i> Back</a>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                <span class="text-xs font-bold text-slate-400">SLUG:</span>
                <input x-model="page.slug" class="bg-transparent text-sm font-bold text-slate-700 outline-none w-32 placeholder-slate-400">
            </div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-white rounded-xl border border-slate-200 p-1 shadow-sm gap-1">
            <button @click="setDevice('desktop')" :class="device=='desktop'?'bg-blue-50 text-blue-600':'text-slate-400'" class="p-2 rounded transition"><i class="ph ph-desktop text-xl"></i></button>
            <button @click="setDevice('tablet')" :class="device=='tablet'?'bg-blue-50 text-blue-600':'text-slate-400'" class="p-2 rounded transition"><i class="ph ph-device-tablet text-xl"></i></button>
            <button @click="setDevice('mobile')" :class="device=='mobile'?'bg-blue-50 text-blue-600':'text-slate-400'" class="p-2 rounded transition"><i class="ph ph-device-mobile text-xl"></i></button>
            <div class="w-px h-5 bg-slate-200 mx-2"></div>
            <button @click="cmd('core:undo')" class="text-slate-400 hover:text-black p-2"><i class="ph ph-arrow-u-up-left text-xl"></i></button>
            <button @click="cmd('core:redo')" class="text-slate-400 hover:text-black p-2"><i class="ph ph-arrow-u-up-right text-xl"></i></button>
            <button @click="cmd('core:preview')" class="text-slate-400 hover:text-blue-600 p-2"><i class="ph ph-eye text-xl"></i></button>
        </div>

        <div class="flex items-center gap-3">
            <button @click="showSettings=true" class="text-slate-500 hover:text-blue-600 p-2 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-200 transition"><i class="ph ph-gear text-2xl"></i></button>
            <button @click="savePage" :disabled="loading" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200 transition flex items-center gap-2">
                <i x-show="loading" class="ph ph-spinner animate-spin"></i>
                <span x-text="loading ? 'Saving...' : 'PUBLISH'"></span>
            </button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-3.5rem)] overflow-hidden">
        <div class="flex-1 relative bg-slate-100 flex flex-col items-center justify-center p-8">
            <div id="gjs" class="flex-1 w-full h-full shadow-2xl rounded-lg overflow-hidden border border-slate-300 bg-white"></div>
        </div>

        <div class="w-[320px] bg-white border-l border-slate-200 flex flex-col z-20 shrink-0 shadow-xl">
            <div class="panel-tabs">
                <button @click="tab='blocks'" :class="tab=='blocks'?'active':''" title="Templates"><i class="ph ph-squares-four"></i></button>
                <button @click="tab='styles'" :class="tab=='styles'?'active':''" title="Styles"><i class="ph ph-paint-brush"></i></button>
                <button @click="tab='traits'" :class="tab=='traits'?'active':''" title="Settings"><i class="ph ph-sliders"></i></button>
                <button @click="tab='layers'" :class="tab=='layers'?'active':''" title="Layers"><i class="ph ph-list-dashes"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto bg-white relative custom-scroll">
                <div x-show="tab=='blocks'" id="blocks-container" class="absolute inset-0 pb-10"></div>
                
                <div x-show="tab=='styles'">
                    <div id="selectors-container" class="p-3 border-b border-slate-100"></div>
                    <div id="styles-container" class="pb-10"></div>
                </div>

                <div x-show="tab=='traits'">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 mb-2 text-xs font-bold text-slate-500 uppercase">Component Properties</div>
                    <div id="traits-container" class="pb-10 px-2"></div>
                </div>

                <div x-show="tab=='layers'" id="layers-container" class="absolute inset-0 pb-10"></div>
            </div>
        </div>
    </div>

    <div x-show="showSettings" x-cloak class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex justify-end" @click.self="showSettings = false">
        <div class="w-[450px] h-full bg-white shadow-2xl flex flex-col transform transition-transform duration-300" x-transition:enter="translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="translate-x-0" x-transition:leave-end="translate-x-full">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="ph ph-faders"></i> Page Configuration</h2>
                <button @click="showSettings = false" class="text-gray-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
                
                <section>
                    <h3 class="text-xs font-bold uppercase text-blue-600 mb-3 border-b border-blue-100 pb-1">Produk & Transaksi</h3>
                    <div class="space-y-4">
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button @click="page.product_type = 'physical'" :class="page.product_type=='physical'?'bg-white text-blue-600 shadow-sm':'text-gray-500'" class="flex-1 py-2 rounded-md text-xs font-bold transition">Fisik (Kirim)</button>
                            <button @click="page.product_type = 'digital'" :class="page.product_type=='digital'?'bg-white text-purple-600 shadow-sm':'text-gray-500'" class="flex-1 py-2 rounded-md text-xs font-bold transition">Digital</button>
                        </div>
                        <div x-show="page.product_type === 'physical'">
                            <label class="block text-[10px] font-bold text-gray-500 mb-1">Berat (Gram)</label>
                            <input x-model="page.config.shipping.weight" type="number" class="w-full border rounded p-2 text-xs" placeholder="1000">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1">Varian Produk</label>
                            <div class="space-y-2">
                                <template x-for="(v, i) in page.config.variants">
                                    <div class="flex gap-2">
                                        <input x-model="v.name" class="flex-1 border rounded px-2 py-1 text-xs" placeholder="Nama">
                                        <input x-model="v.price" type="number" class="w-24 border rounded px-2 py-1 text-xs" placeholder="Rp">
                                        <button @click="page.config.variants.splice(i,1)" class="text-red-400"><i class="ph ph-trash"></i></button>
                                    </div>
                                </template>
                                <button @click="addVariant" class="text-xs text-blue-600 font-bold hover:underline">+ Tambah Varian</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-xs font-bold uppercase text-green-600 mb-3 border-b border-green-100 pb-1">SEO & Social Media</h3>
                    <div class="space-y-3">
                        <input x-model="page.config.settings.seo_title" class="w-full border rounded p-2 text-xs" placeholder="Page Title">
                        <textarea x-model="page.config.settings.seo_description" class="w-full border rounded p-2 text-xs" placeholder="Meta Description" rows="2"></textarea>
                        <input x-model="page.config.settings.favicon" class="w-full border rounded p-2 text-xs font-mono" placeholder="Favicon URL">
                        <div class="pt-2 border-t border-dashed">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">OPEN GRAPH IMAGE</label>
                            <input x-model="page.config.settings.og_image" class="w-full border rounded p-2 text-xs font-mono" placeholder="https://...">
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-xs font-bold uppercase text-orange-600 mb-3 border-b border-orange-100 pb-1">Tracking & Scripts</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <input x-model="page.config.settings.fb_pixel_id" class="border rounded p-2 text-xs" placeholder="FB Pixel ID">
                            <input x-model="page.config.settings.tiktok_pixel_id" class="border rounded p-2 text-xs" placeholder="TikTok Pixel ID">
                        </div>
                        <textarea x-model="page.config.settings.custom_head" class="w-full border rounded p-2 text-xs font-mono bg-gray-50" placeholder="Custom Head Script..." rows="3"></textarea>
                        <textarea x-model="page.config.settings.custom_footer" class="w-full border rounded p-2 text-xs font-mono bg-gray-50" placeholder="Custom Footer Script..." rows="3"></textarea>
                    </div>
                </section>

                <section>
                    <h3 class="text-xs font-bold uppercase text-gray-600 mb-3 border-b border-gray-100 pb-1">API Credentials</h3>
                    <div class="bg-gray-100 p-3 rounded-lg space-y-2">
                        <select x-model="cred.provider" class="w-full border rounded p-1.5 text-xs">
                            <option value="midtrans">Midtrans</option>
                            <option value="cloudinary">Cloudinary</option>
                        </select>
                        <textarea x-model="cred.data" class="w-full border rounded p-2 text-xs font-mono" placeholder='{"server_key":"..."}' rows="3"></textarea>
                        <button @click="saveCreds" class="w-full bg-slate-800 text-white py-1.5 rounded text-xs font-bold">Simpan Key</button>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <script>
        function editorApp() {
            return {
                loading: false, showSettings: false, device: 'desktop', tab: 'blocks',
                page: { 
                    slug: '', title: '', product_type: 'physical',
                    config: { variants:[], shipping: {weight:1000}, settings: {} } 
                },
                cred: { provider: 'midtrans', data: '' },
                authPass: localStorage.getItem('admin_pass'),

                init() {
                    const params = new URLSearchParams(window.location.search);
                    this.page.slug = params.get('slug');
                    if(!this.authPass) window.location.href='/login';
                    this.initGrapes();
                },

                setDevice(d) { this.device=d; window.editor.setDevice(d); },
                cmd(c) { window.editor.runCommand(c); },
                addVariant() { this.page.config.variants.push({id:Date.now(), name:'', price:0}) },
                
                async saveCreds() {
                    try {
                        await fetch('/api/admin/credentials', {
                            method:'POST', headers:{'Authorization':this.authPass},
                            body:JSON.stringify({provider:this.cred.provider, data:JSON.parse(this.cred.data)})
                        });
                        alert('Tersimpan!');
                    } catch(e){ alert('JSON Invalid'); }
                },

                async savePage() {
                    this.loading=true;
                    try {
                        await fetch('/api/admin/pages', {
                            method:'POST', headers:{'Authorization':this.authPass},
                            body:JSON.stringify({
                                slug:this.page.slug, title:this.page.title, product_type:this.page.product_type,
                                html:editor.getHtml(), css:editor.getCss(), product_config:this.page.config
                            })
                        });
                        alert('Berhasil disimpan!');
                    } catch(e){ alert('Gagal'); }
                    this.loading=false;
                },

                initGrapes() {
                    setTimeout(() => {
                        window.editor = grapesjs.init({
                            container: '#gjs', height: '100%', fromElement: false, storageManager: false,
                            plugins: [
                                'gjs-blocks-basic', 'grapesjs-plugin-forms', 'grapesjs-component-countdown', 
                                'grapesjs-custom-code'
                            ],
                            pluginsOpts: { 'gjs-blocks-basic': { flexGrid: true } },
                            deviceManager: {
                                devices: [
                                    { id: 'desktop', name: 'Desktop', width: '' },
                                    { id: 'tablet', name: 'Tablet', width: '768px', widthMedia: '992px' },
                                    { id: 'mobile', name: 'Mobile', width: '375px', widthMedia: '480px' }
                                ]
                            },
                            blockManager: { appendTo: '#blocks-container' },
                            layerManager: { appendTo: '#layers-container' },
                            selectorManager: { appendTo: '#styles-container' },
                            traitManager: { appendTo: '#traits-container' },
                            styleManager: { appendTo: '#styles-container', sectors: [
                                { name: 'Typography', open: true, buildProps: ['font-family', 'font-size', 'font-weight', 'line-height', 'color', 'text-align'] },
                                { name: 'Dimensions', open: false, buildProps: ['width', 'height', 'max-width', 'min-height', 'padding', 'margin'] },
                                { name: 'Layout', open: false, buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'gap'] },
                                { name: 'Decorations', open: false, buildProps: ['background-color', 'border', 'border-radius', 'box-shadow'] }
                            ]},
                            assetManager: { 
                                upload: '/api/admin/upload-image', uploadName: 'file', 
                                headers: { 'Authorization': this.authPass }, autoAdd: true 
                            }
                        });

                        // ----------------------------------------------------
                        // PRE-TEMPLATES (SOLUSI LAYOUT MUDAH)
                        // ----------------------------------------------------
                        const bm = editor.BlockManager;

                        // 1. HERO SECTION (Auto Center)
                        bm.add('hero-tpl', {
                            label: 'Hero Header', category: 'Templates', attributes: { class: 'ph ph-layout' },
                            content: `
                                <section style="padding: 80px 20px; background-color: #f8fafc; display: flex; justify-content: center;">
                                    <div style="max-width: 1100px; width: 100%; text-align: center;">
                                        <h1 style="font-size: 3rem; margin-bottom: 20px; color: #1e293b; font-weight: 800;">Headline Menarik Anda</h1>
                                        <p style="font-size: 1.25rem; color: #64748b; margin-bottom: 30px; max-width: 700px; margin-left: auto; margin-right: auto;">Deskripsi singkat yang menjelaskan produk Anda dengan jelas dan mengajak orang untuk membeli.</p>
                                        <a href="#checkout" style="display: inline-block; padding: 15px 40px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 1.1rem;">Beli Sekarang</a>
                                    </div>
                                </section>
                            `
                        });

                        // 2. FEATURES GRID (Responsive)
                        bm.add('features-tpl', {
                            label: 'Features Grid', category: 'Templates', attributes: { class: 'ph ph-grid-four' },
                            content: `
                                <section style="padding: 60px 20px; display: flex; justify-content: center;">
                                    <div style="max-width: 1100px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                                        <div style="padding: 30px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center;">
                                            <div style="font-size: 40px; margin-bottom: 15px;">‚ö°</div>
                                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">Fitur Cepat</h3>
                                            <p style="color: #64748b;">Penjelasan fitur unggulan pertama di sini.</p>
                                        </div>
                                        <div style="padding: 30px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center;">
                                            <div style="font-size: 40px; margin-bottom: 15px;">üõ°Ô∏è</div>
                                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">Aman Terjamin</h3>
                                            <p style="color: #64748b;">Penjelasan fitur unggulan kedua di sini.</p>
                                        </div>
                                        <div style="padding: 30px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center;">
                                            <div style="font-size: 40px; margin-bottom: 15px;">üíé</div>
                                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">Kualitas Tinggi</h3>
                                            <p style="color: #64748b;">Penjelasan fitur unggulan ketiga di sini.</p>
                                        </div>
                                    </div>
                                </section>
                            `
                        });

                        // 3. VIDEO YOUTUBE (Wrapper Responsive)
                        bm.add('video-yt', {
                            label: 'Youtube Video', category: 'Templates', attributes: { class: 'ph ph-youtube-logo' },
                            content: {
                                type: 'video',
                                provider: 'yt',
                                videoId: 'dQw4w9WgXcQ', // Default ID
                                style: { height: '400px', width: '100%', maxWidth: '800px', margin: '0 auto', display: 'block' }
                            }
                        });

                        // 4. CHECKOUT (Pre-styled)
                        bm.add('checkout-tpl', {
                            label: 'Checkout Form', category: 'Templates', attributes: { class: 'ph ph-shopping-cart' },
                            content: `
                                <section id="checkout" style="padding: 60px 20px; background-color: #eff6ff; display: flex; justify-content: center;">
                                    <div style="max-width: 600px; width: 100%; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                                        <h2 style="text-align: center; margin-bottom: 20px; color: #1e40af;">Form Pemesanan</h2>
                                        <div data-gjs-type="checkout-widget" style="padding: 20px; border: 2px dashed #3b82f6; text-align: center; border-radius: 8px; color: #64748b;">
                                            [Form Checkout Otomatis Akan Muncul Di Sini]
                                        </div>
                                    </div>
                                </section>
                            `
                        });

                        // 5. CUSTOM HTML (Embed)
                        bm.add('custom-code-blk', {
                            label: 'Custom Code', category: 'Extra', attributes: { class: 'ph ph-code' },
                            content: { type: 'custom-code', content: '' }
                        });

                        // LOAD KONTEN
                        editor.on('load', () => {
                            editor.Canvas.getBody().style.backgroundColor = '#ffffff';
                            if(this.page.slug) {
                                fetch('/api/admin/pages/'+this.page.slug).then(r=>r.json()).then(d=>{
                                    if(d.id) {
                                        this.page.title=d.title; this.page.product_type=d.product_type||'physical';
                                        try { this.page.config = JSON.parse(d.product_config_json||'{}'); } catch(e){ this.page.config={variants:[],settings:{}}; }
                                        if(!this.page.config.settings) this.page.config.settings={};
                                        if(!this.page.config.shipping) this.page.config.shipping={weight:1000};
                                        if(d.html_content) editor.setComponents(d.html_content);
                                        if(d.css_content) editor.setStyle(d.css_content);
                                    }
                                });
                            }
                        });

                    }, 100);
                }
            }
        }
    </script>
</body>
</html>
