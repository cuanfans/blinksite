<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder - Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs@0.21.2/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs@0.21.2/dist/grapes.min.js"></script>
    
    <script src="https://unpkg.com/grapesjs-blocks-basic@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-plugin-forms@2.0.5"></script>
    <script src="https://unpkg.com/grapesjs-navbar@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-component-countdown@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-tabs@1.0.6"></script>
    <script src="https://unpkg.com/grapesjs-custom-code@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-tooltip@0.1.7"></script>
    <script src="https://unpkg.com/grapesjs-blocks-flexbox@0.1.1"></script>
    <script src="https://unpkg.com/grapesjs-plugin-export@1.0.11"></script>
    <script src="https://unpkg.com/grapesjs-typed@1.0.5"></script>
    <script src="https://unpkg.com/grapesjs-style-bg@2.0.1"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* RESET & BASE */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #fff; color: #1e293b; }
        [x-cloak] { display: none !important; }
        
        /* GRAPESJS UI OVERRIDES (CRITICAL FOR COLOR PICKER) */
        .gjs-pn-top-panel, .gjs-pn-views-container, .gjs-pn-views { display: none !important; }
        
        /* Panel properties harus visible tapi tidak menghalangi
           NOTE: sebelumnya panel dibuat width/height 0 — itu mencegah
           color picker popup ter-render. Ubah jadi auto agar popover
           (color picker) dapat muncul. Pointer-events di-enable agar
           elemen popover dapat diklik. */
        .gjs-pn-panels {
            position: fixed;
            bottom: 0;
            left: 0;
            width: auto;     /* allow popovers to position */
            height: auto;    /* allow popovers to show */
            z-index: 9999;
            overflow: visible;
            display: block !important;
            pointer-events: auto;
        }
        .gjs-pn-panels * { pointer-events: auto; } /* Re-enable click for popups */

        .gjs-cv-canvas { width: 100%; height: 100%; top: 0 !important; background-color: #f8fafc; }
        .gjs-selected { outline: 2px solid #2563eb !important; outline-offset: -2px; }
        
        /* INPUTS & COLOR PICKER */
        .input-std { width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px; font-size: 12px; outline: none; transition: border-color 0.2s; }
        .input-std:focus { border-color: #2563eb; }
        .gjs-field-color-picker { width: 100%; min-width: 30px; height: 25px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* PANEL UI */
        .panel-tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .panel-tabs button { flex: 1; padding: 12px; color: #94a3b8; font-size: 20px; transition: all 0.2s; }
        .panel-tabs button:hover { color: #334155; background: #f8fafc; }
        .panel-tabs button.active { color: #2563eb; border-bottom: 2px solid #2563eb; background: #eff6ff; }
        
        /* BLOCKS */
        .gjs-blocks-c { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px; background: #fff; }
        .gjs-block { width: 100% !important; min-height: auto !important; padding: 15px 5px !important; margin: 0 !important; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: grab; transition: all 0.15s; }
        .gjs-block:hover { border-color: #3b82f6; color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .gjs-block-label { font-size: 10px; font-weight: 600; text-align: center; margin-top: 4px; color: #475569; }
        .gjs-block-category .gjs-title { background: #f8fafc; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 8px 12px; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
    </style>
</head>

<body x-data="editorApp()">

    <div class="fixed bottom-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none">
        <template x-for="n in notifications" :key="n.id">
            <div x-show="n.show" x-transition class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border-l-4 bg-white min-w-[250px]" :class="n.type==='success'?'border-green-500':'border-red-500'">
                <i class="ph text-xl" :class="n.type==='success'?'ph-check-circle text-green-500':'ph-warning-circle text-red-500'"></i>
                <div><h4 class="text-xs font-bold text-gray-800" x-text="n.title"></h4><p class="text-[10px] text-gray-500" x-text="n.msg"></p></div>
            </div>
        </template>
    </div>

    <div id="iconify-picker-modal" class="fixed inset-0 hidden z-[99999] bg-black/40 flex items-start justify-center p-6 backdrop-blur-sm">
      <div class="bg-white rounded-lg w-full max-w-2xl shadow-2xl overflow-hidden mt-10">
        <div class="flex items-center justify-between p-4 border-b bg-gray-50">
          <div class="flex items-center gap-2 w-full">
            <i class="ph ph-magnifying-glass text-lg text-gray-500"></i>
            <input id="iconify-picker-search" placeholder="Cari icon, mis. ph:heart atau hanya 'heart'" class="w-full bg-transparent outline-none text-sm ml-2" />
            <button id="iconify-picker-clear" class="ml-2 text-xs font-bold text-gray-400 hover:text-red-500">CLEAR</button>
          </div>
          <button id="iconify-picker-close" class="ml-4 text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
        </div>
        <div id="iconify-picker-results" class="p-4 grid grid-cols-6 gap-3 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="col-span-full text-center text-gray-400 text-xs py-8">Ketik pencarian di atas...</div>
        </div>
        <div class="p-3 text-[10px] text-gray-400 border-t bg-gray-50 flex justify-between">
            <span>Tip: Double-click icon di canvas untuk mengganti.</span>
            <span class="font-mono">Powered by Iconify</span>
        </div>
      </div>
    </div>

    <header class="h-14 bg-white border-b border-gray-200 flex justify-between items-center px-4 z-50 relative shrink-0">
        <div class="flex items-center gap-4">
            <a href="/admin/pages" class="text-gray-400 hover:text-blue-600 transition"><i class="ph ph-arrow-left text-xl"></i></a>
            <div class="h-6 w-px bg-gray-200"></div>
            <div><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">Page Slug</span><input x-model="page.slug" class="bg-transparent font-mono font-bold text-sm text-gray-700 outline-none w-48 placeholder-gray-300" placeholder="nama-halaman"></div>
        </div>
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
            <button @click="setDevice('desktop')" :class="device=='desktop'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-desktop text-lg"></i></button>
            <button @click="setDevice('tablet')" :class="device=='tablet'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-device-tablet text-lg"></i></button>
            <button @click="setDevice('mobile')" :class="device=='mobile'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-device-mobile text-lg"></i></button>
            <div class="w-px h-5 bg-gray-300 mx-2"></div>
            <button @click="cmd('core:preview')" class="text-gray-500 hover:text-blue-600 p-2"><i class="ph ph-eye text-lg"></i></button>
            <button @click="cmd('core:undo')" class="text-gray-400 hover:text-gray-700 p-2"><i class="ph ph-arrow-u-up-left text-lg"></i></button>
            <button @click="cmd('core:redo')" class="text-gray-400 hover:text-gray-700 p-2"><i class="ph ph-arrow-u-up-right text-lg"></i></button>
        </div>
        <div class="flex items-center gap-3">
            <button @click="cmd('gjs-export-zip')" class="text-gray-500 hover:text-green-600 flex items-center gap-1 text-xs font-bold px-2"><i class="ph ph-download-simple text-lg"></i> ZIP</button>
            <button @click="showSettings=true" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-3 py-2 rounded-md text-xs font-bold flex items-center gap-2 border border-gray-200"><i class="ph ph-gear-six text-lg"></i> Settings</button>
            <button @click="savePage" :disabled="loading" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-md text-xs font-bold transition flex items-center gap-2 disabled:opacity-50 shadow-lg shadow-blue-500/30"><i x-show="loading" class="ph ph-spinner animate-spin"></i><span x-text="loading ? 'SAVING...' : 'PUBLISH'"></span></button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-3.5rem)] overflow-hidden">
        <div class="flex-1 relative bg-[#f8fafc] flex flex-col items-center justify-center p-8 overflow-hidden">
            <div id="gjs" class="flex-1 w-full h-full shadow-xl rounded-lg overflow-hidden border border-gray-300 bg-white ring-4 ring-gray-100"></div>
        </div>
        <div class="w-[320px] bg-white border-l border-gray-200 flex flex-col z-20 shrink-0 shadow-[0_0_20px_rgba(0,0,0,0.05)]">
            <div class="panel-tabs">
                <button @click="tab='blocks'" :class="tab=='blocks'?'active':''" title="Elements"><i class="ph ph-plus-square"></i></button>
                <button @click="tab='styles'" :class="tab=='styles'?'active':''" title="Style"><i class="ph ph-paint-brush"></i></button>
                <button @click="tab='traits'" :class="tab=='traits'?'active':''" title="Settings"><i class="ph ph-sliders"></i></button>
                <button @click="tab='layers'" :class="tab=='layers'?'active':''" title="Layers"><i class="ph ph-tree-structure"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-white relative custom-scroll">
                <div x-show="tab=='blocks'" id="blocks-container" class="absolute inset-0 pb-20"></div>
                <div x-show="tab=='styles'"><div id="selectors-container" class="p-3 border-b bg-gray-50"></div><div id="styles-container" class="pb-20"></div></div>
                <div x-show="tab=='traits'"><div class="p-3 bg-gray-50 text-gray-500 text-[10px] font-bold uppercase tracking-widest border-b">Settings</div><div id="traits-container" class="p-2 pb-20"></div></div>
                <div x-show="tab=='layers'" id="layers-container" class="absolute inset-0 pb-20"></div>
            </div>
        </div>
    </div>

    <div x-show="showSettings" x-cloak class="fixed inset-0 z-[200] bg-slate-900/50 backdrop-blur-sm flex justify-end" @click.self="showSettings = false">
        <div class="w-[400px] h-full bg-white shadow-2xl flex flex-col" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-gray-800 flex items-center gap-2"><i class="ph ph-faders text-blue-600"></i> Page Configuration</h2>
                <button @click="showSettings = false" class="text-gray-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
                <div><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Product</h3><div class="flex bg-gray-100 p-1 rounded-lg mb-4"><button @click="page.product_type='physical'" :class="page.product_type=='physical'?'bg-white shadow text-blue-600':''" class="flex-1 py-1.5 text-xs font-bold rounded-md transition">PHYSICAL</button><button @click="page.product_type='digital'" :class="page.product_type=='digital'?'bg-white shadow text-blue-600':''" class="flex-1 py-1.5 text-xs font-bold rounded-md transition">DIGITAL</button></div><div x-show="page.product_type==='physical'"><label class="text-[11px] font-bold text-gray-600">Weight (gram)</label><input x-model="page.config.shipping.weight" type="number" class="input-std mt-1"></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Variants</h3><div class="space-y-2"><template x-for="(v, i) in page.config.variants"><div class="flex gap-2 items-center"><input x-model="v.name" class="input-std flex-1" placeholder="Name"><input x-model="v.price" type="number" class="input-std w-24" placeholder="Price"><button @click="page.config.variants.splice(i,1)" class="text-red-400 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></template><button @click="addVariant" class="w-full border-2 border-dashed border-gray-300 text-gray-500 font-bold text-xs py-2 rounded hover:border-blue-400 transition">+ Add Variant</button></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-3">Order Bump</h3><div class="flex items-center gap-2 mb-2"><input type="checkbox" x-model="page.config.order_bump.active"><span class="text-xs">Aktif</span></div><div x-show="page.config.order_bump.active" class="space-y-3 bg-purple-50 p-4 rounded-lg border border-purple-100"><input x-model="page.config.order_bump.title" class="input-std" placeholder="Title"><input x-model="page.config.order_bump.price" type="number" class="input-std" placeholder="Price"><textarea x-model="page.config.order_bump.desc" class="input-std" rows="2" placeholder="Desc"></textarea></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-red-500 uppercase tracking-wider mb-3">Coupons</h3><template x-for="(c, i) in page.config.coupons"><div class="bg-red-50 p-2 mb-2 rounded border border-red-100 flex gap-2"><input x-model="c.code" class="input-std" placeholder="CODE"><input x-model="c.value" type="number" class="input-std w-20" placeholder="Val"><button @click="page.config.coupons.splice(i,1)" class="text-red-500"><i class="ph ph-x"></i></button></div></template><button @click="page.config.coupons.push({code:'', type:'percent', value:0})" class="w-full py-2 text-xs font-bold text-red-500 border border-red-200 rounded hover:bg-red-50 transition">+ Add Coupon</button></div>
                <div class="border-t pt-6 space-y-4"><h3 class="text-xs font-bold text-green-600 uppercase tracking-wider">SEO</h3><div><label class="text-[10px] font-bold text-gray-500">Title</label><input x-model="page.config.settings.seo_title" class="input-std"></div><div><label class="text-[10px] font-bold text-gray-500">Desc</label><textarea x-model="page.config.settings.seo_description" class="input-std" rows="2"></textarea></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-gray-500">Favicon</label><input x-model="page.config.settings.favicon" class="input-std"></div><div><label class="text-[10px] font-bold text-gray-500">OG Image</label><input x-model="page.config.settings.og_image" class="input-std"></div></div></div>
                <div class="border-t pt-6 bg-gray-50 -mx-6 px-6 pb-6"><h3 class="text-xs font-bold text-gray-800 uppercase tracking-wider mb-3 pt-4">API</h3><select x-model="cred.provider" class="input-std mb-2 bg-white"><option value="midtrans">Midtrans</option><option value="cloudinary">Cloudinary</option></select><textarea x-model="cred.data" class="input-std font-mono text-[10px] bg-white" rows="3" placeholder='JSON Config'></textarea><button @click="saveCreds" class="w-full bg-gray-800 text-white py-2 rounded mt-3 text-xs font-bold hover:bg-black transition">Save</button></div>
            </div>
        </div>
    </div>

    <script>
    // --- 1. ICONIFY PICKER LOGIC (PATCHED) ---
    (function(){
      let iconifyPickerState = { model: null };
      const modal = document.getElementById('iconify-picker-modal');
      const input = document.getElementById('iconify-picker-search');
      const results = document.getElementById('iconify-picker-results');
      const closeBtn = document.getElementById('iconify-picker-close');
      const clearBtn = document.getElementById('iconify-picker-clear');

      window.openIconifyPicker = function(model){
        iconifyPickerState.model = model || null;
        modal.classList.remove('hidden');
        input.focus();
        try {
          const cur = model && model.get ? (model.get('attributes') || {}).icon : '';
          input.value = cur || '';
          if(cur) doSearch(cur); 
        } catch(e){ input.value=''; }
      };

      function closeIconifyPicker(){
        modal.classList.add('hidden');
        iconifyPickerState.model = null;
        results.innerHTML = '<div class="col-span-full text-center text-gray-400 text-xs py-8">Ketik pencarian di atas...</div>';
      }

      function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

      async function searchIconify(q){
        if(!q) return [];
        const plain = q.includes(':') ? q.split(':').pop() : q;
        const qEnc = encodeURIComponent(plain);
        try {
          const res = await fetch(`https://api.iconify.design/search?query=${qEnc}&limit=24`);
          if(!res.ok) return [];
          const json = await res.json();
          if(Array.isArray(json.icons)) return json.icons;
          return [];
        } catch(e){ return []; }
      }

      function renderResults(list){
        results.innerHTML = '';
        if(!list || list.length===0){
          results.innerHTML = `<div class="col-span-6 text-sm text-gray-500 text-center">Tidak ada hasil</div>`;
          return;
        }
        list.forEach(iconName=>{
          const btn = document.createElement('button');
          btn.className = 'flex flex-col items-center gap-1 p-2 rounded hover:bg-blue-50 border border-transparent hover:border-blue-200 transition';
          btn.innerHTML = `<iconify-icon icon="${iconName}" width="28" style="color:#333;"></iconify-icon><span class="text-[9px] text-gray-500 truncate w-full text-center">${iconName}</span>`;
          btn.addEventListener('click', ()=>{
            applyIconToModel(iconName);
            closeIconifyPicker();
          });
          results.appendChild(btn);
        });
      }

      function applyIconToModel(iconName){
        if(iconifyPickerState.model && window.editor){
           const m = iconifyPickerState.model;
           if(typeof m.addAttributes === 'function') {
               m.addAttributes({ icon: iconName });
               // Try to force re-render of the canvas item
               try { m.view && m.view.render && m.view.render(); } catch(e){}
           }
        }
      }

      const doSearch = debounce(async (q) => {
        const list = await searchIconify(q.trim());
        renderResults(list);
      }, 300);

      input.addEventListener('input', (e)=> doSearch(e.target.value));
      closeBtn.addEventListener('click', closeIconifyPicker);
      clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); });
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeIconifyPicker(); });

      // Init Grapes integration
      const initInterval = setInterval(()=>{
        if(window.editor){
            window.editor.on('component:dblclick', (model) => {
                const tag = model.get && model.get('tagName') ? model.get('tagName') : null;
                if(tag === 'iconify-icon') openIconifyPicker(model);
            });
            clearInterval(initInterval);
        }
      }, 500);
    })();

    // --- 2. MAIN EDITOR APP ---
    function editorApp() {
        return {
            loading: false, showSettings: false, device: 'desktop', tab: 'blocks',
            notifications: [],
            page: { slug: '', title: '', product_type: 'physical', config: { variants:[], shipping:{weight:1000}, order_bump:{active:false, title:'', price:0, desc:''}, coupons:[], settings:{} } },
            cred: { provider: 'midtrans', data: '' },
            authPass: localStorage.getItem('admin_pass'),

            init() {
                const params = new URLSearchParams(window.location.search);
                this.page.slug = params.get('slug');
                if(!this.authPass) window.location.href='/login';
                this.initGrapes();
            },

            notify(title, msg, type='success') { const id=Date.now(); this.notifications.push({id, title, msg, type, show:true}); setTimeout(()=>{ const idx=this.notifications.findIndex(n=>n.id===id); if(idx>-1)this.notifications[idx].show=false; }, 3000); },
            setDevice(d) { this.device=d; window.editor.setDevice(d); },
            cmd(c) { window.editor.runCommand(c); },
            addVariant() { this.page.config.variants.push({id:Date.now(), name:'', price:0}) },
            async saveCreds() { try { await fetch('/api/admin/credentials', {method:'POST', headers:{'Authorization':this.authPass}, body:JSON.stringify({provider:this.cred.provider, data:JSON.parse(this.cred.data)})}); this.notify('Berhasil','Key tersimpan!'); } catch(e){ this.notify('Gagal','JSON Invalid','error'); } },
            async savePage() { this.loading=true; try { await fetch('/api/admin/pages', {method:'POST', headers:{'Authorization':this.authPass}, body:JSON.stringify({slug:this.page.slug, title:this.page.title, product_type:this.page.product_type, html:editor.getHtml(), css:editor.getCss(), product_config:this.page.config})}); this.notify('Sukses','Halaman tersimpan!'); } catch(e){ this.notify('Error','Gagal simpan.','error'); } this.loading=false; },
            
            initGrapes() {
                setTimeout(() => {
                    window.editor = grapesjs.init({
                        container: '#gjs', height: '100%', fromElement: false, storageManager: false,
                        plugins: [
                            'gjs-blocks-basic', 'grapesjs-plugin-forms', 'grapesjs-navbar', 'grapesjs-component-countdown', 'grapesjs-tabs', 
                            'grapesjs-custom-code', 'grapesjs-tooltip', 'grapesjs-blocks-flexbox', 'grapesjs-plugin-export', 'grapesjs-typed', 'grapesjs-style-bg'
                        ],
                        pluginsOpts: { 'gjs-blocks-basic': { flexGrid: true } },
                        deviceManager: { devices: [{id:'desktop',width:''}, {id:'tablet',width:'768px'}, {id:'mobile',width:'375px'}] },
                        blockManager: { appendTo: '#blocks-container' },
                        layerManager: { appendTo: '#layers-container' },
                        selectorManager: { appendTo: '#selectors-container' },
                        traitManager: { appendTo: '#traits-container' },
                        // FIX COLOR PICKER & PANEL VISIBILITY
                        styleManager: { 
                            appendTo: '#styles-container', 
                            sectors: [
                                { name: 'Typography', open: true, buildProps: ['font-family', 'font-size', 'font-weight', 'line-height', 'color', 'text-align'], properties: [{ property: 'color', type: 'color' }] }, 
                                { name: 'Dimensions', open: false, buildProps: ['width', 'height', 'padding', 'margin'] }, 
                                { name: 'Decorations', open: false, buildProps: ['background-color', 'border', 'border-radius', 'box-shadow'], properties: [{ property: 'background-color', type: 'color' }, { property: 'border-color', type: 'color' }] }
                            ] 
                        },
                        assetManager: { upload: false, autoAdd: true, uploadFile: async (e) => { /* Upload */ } }
                    });

                    // --- 3. COMPONENT DEFINITIONS & TABLE TOOLING (IMPROVED) ---
                    const domc = editor.DomComponents;

                    // Ensure a basic 'textnode' type exists for cell content (keeps editing simple)
                    // (do not change other types/handlers)
                    try {
                      domc.addType('textnode', {
                        model: {
                          defaults: {
                            editable: true
                          }
                        },
                        view: {}
                      });
                    } catch(e){ /* ignore if already registered */ }

                    // CELL type: td/th. Force editable and keep small default.
                    domc.addType('cell', {
                        model: {
                            defaults: {
                                tagName: 'td',
                                draggable: false,
                                droppable: true,
                                editable: true, // Force editable
                                // Use a simple text node inside which is editable
                                components: [{ type: 'textnode', content: 'Cell' }],
                                // Allow inline styles via Style Manager color picker etc.
                                traits: []
                            }
                        }
                    });

                    // Robust helper: find ancestor by tagName on a component model
                    const findAncestorByTag = (model, tag) => {
                        if(!model) return null;
                        let m = model;
                        tag = (tag || '').toLowerCase();
                        while(m) {
                            const t = (m.get && m.get('tagName')) ? (''+m.get('tagName')).toLowerCase() : (m.tagName || '').toLowerCase();
                            if(t === tag) return m;
                            m = (typeof m.parent === 'function') ? m.parent() : (m.parent || null);
                        }
                        return null;
                    };

                    // Helper to get all rows (tr components) in a table (thead + tbody)
                    const getTableRows = (table) => {
                        if(!table) return [];
                        const rows = [];
                        const findRows = (comp) => {
                            const tag = comp.get('tagName') ? comp.get('tagName').toLowerCase() : '';
                            if(tag === 'tr') rows.push(comp);
                            const comps = comp.components ? comp.components() : [];
                            if(Array.isArray(comps)) {
                                comps.forEach(c => findRows(c));
                            }
                        };
                        const comps = table.components ? table.components() : [];
                        comps.forEach(c => findRows(c));
                        return rows;
                    };

                    // Command: add row below the currently selected row (or append to tbody)
                    editor.Commands.add('table-add-row', {
                        run(editor, sender) {
                            const sel = editor.getSelected();
                            if(!sel) return;
                            const table = findAncestorByTag(sel, 'table');
                            if(!table) return;
                            // find tbody if present, else use table
                            const tbody = (table.components && table.components().models.find(m => (m.get('tagName')||'').toLowerCase()==='tbody')) || table;
                            const rows = tbody.components ? tbody.components() : [];
                            if(rows.length === 0) {
                                // create a default row with one cell
                                tbody.append({ tagName: 'tr', components: [{ type: 'cell', components: [{ type: 'textnode', content: 'Cell' }] }] });
                                return;
                            }
                            // Clone last row structure
                            const lastRow = rows[rows.length - 1];
                            tbody.append(lastRow.clone());
                        }
                    });

                    // Command: add column to every row (appends a new td)
                    editor.Commands.add('table-add-col', {
                        run(editor, sender) {
                            const sel = editor.getSelected();
                            if(!sel) return;
                            const table = findAncestorByTag(sel, 'table');
                            if(!table) return;
                            const rows = getTableRows(table);
                            if(rows.length === 0) {
                                // create simple structure if none found
                                table.append({ tagName: 'tr', components: [{ type: 'cell', components: [{ type: 'textnode', content: 'Cell' }] }] });
                                return;
                            }
                            rows.forEach(row => {
                                // add a new td cell
                                row.append({ type: 'cell', components: [{ type: 'textnode', content: 'Cell' }], attributes: { style: 'padding:10px; border:1px solid #ddd;' } });
                            });
                        }
                    });

                    // Command: delete selected row (if more than 1)
                    editor.Commands.add('table-del-row', {
                        run(editor, sender) {
                            const sel = editor.getSelected();
                            if(!sel) return;
                            const row = findAncestorByTag(sel, 'tr');
                            if(!row) return;
                            const parent = row.parent ? row.parent() : null;
                            const siblings = parent && parent.components ? parent.components() : [];
                            if((siblings && siblings.length) > 1) row.remove();
                            else alert('Minimal sisakan 1 baris.');
                        }
                    });

                    // Command: delete last column from every row (ensure at least 1 column remains)
                    editor.Commands.add('table-del-col', {
                        run(editor, sender) {
                            const sel = editor.getSelected();
                            if(!sel) return;
                            const table = findAncestorByTag(sel, 'table');
                            if(!table) return;
                            const rows = getTableRows(table);
                            if(rows.length === 0) return;
                            // Check current min cells across rows
                            let minCells = Infinity;
                            const rowCells = rows.map(r => {
                                const cells = (r.components && r.components().models.filter(c => ((c.get && c.get('tagName')||'').toLowerCase()==='td' || (c.get && c.get('tagName')||'').toLowerCase()==='th'))) || [];
                                if(cells.length < minCells) minCells = cells.length;
                                return cells;
                            });
                            if(minCells <= 1) { alert('Minimal sisakan 1 kolom.'); return; }
                            rowCells.forEach(cells => {
                                if(cells.length > 0) {
                                    cells[cells.length - 1].remove();
                                }
                            });
                        }
                    });

                    // Table type: add toolbar/traits for row/col manipulation
                    domc.addType('table', {
                        model: {
                            defaults: {
                                tagName: 'table',
                                traits: [
                                    { type: 'button', text: '➕ Row', full: true, command: 'table-add-row' },
                                    { type: 'button', text: '➕ Col', full: true, command: 'table-add-col' },
                                    { type: 'button', text: '➖ Row', full: true, command: 'table-del-row' },
                                    { type: 'button', text: '➖ Col', full: true, command: 'table-del-col' }
                                ],
                                style: { width: '100%', borderCollapse: 'collapse' }
                            }
                        }
                    });

                    // When a component is selected, ensure nearest td/th is editable (fix inline-edit when text node selected)
                    editor.on('component:selected', (model) => {
                        if(!model) return;
                        // If the model itself is a cell, ensure editable
                        const tag = model.get && model.get('tagName') ? (''+model.get('tagName')).toLowerCase() : '';
                        if(tag === 'td' || tag === 'th' || (model.is && model.is('cell'))) {
                            try { model.set && model.set('editable', true); } catch(e){}
                            return;
                        }
                        // Traverse up to find a td/th
                        let parent = model;
                        while(parent) {
                            const pTag = parent.get && parent.get('tagName') ? (''+parent.get('tagName')).toLowerCase() : '';
                            if(pTag === 'td' || pTag === 'th' || (parent.is && parent.is('cell'))) {
                                try { parent.set && parent.set('editable', true); } catch(e){}
                                break;
                            }
                            parent = (typeof parent.parent === 'function') ? parent.parent() : (parent.parent || null);
                        }
                    });

                    // --- 4. BLOCKS: tables + pricelist/comparison (UPDATED) ---
                    const bm = editor.BlockManager;
                    bm.add('container-fluid', { label: 'Container', category: 'Layout', content: `<div style="width:90%; max-width:1200px; margin:0 auto; padding:20px; min-height:50px;"></div>` });
                    bm.add('section-std', { label: 'Section', category: 'Layout', content: `<section style="padding:60px 0; background-color:#fff;"><div style="width:90%; max-width:1100px; margin:0 auto; padding:0 20px;"></div></section>` });
                    
                    // PURE TABLE (editable cells + table traits)
                    bm.add('table-pure', {
                        label: 'Pure Table',
                        category: 'Tables',
                        attributes: { class: 'ph ph-table' },
                        content: {
                            type: 'table',
                            components: [
                                {
                                    tagName: 'thead',
                                    components: [
                                        { tagName: 'tr', components: [
                                            { type:'cell', tagName: 'th', components: [{ type:'textnode', content: 'Header 1' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0; text-align:left; background:#f8fafc;' } },
                                            { type:'cell', tagName: 'th', components: [{ type:'textnode', content: 'Header 2' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0; text-align:left; background:#f8fafc;' } },
                                            { type:'cell', tagName: 'th', components: [{ type:'textnode', content: 'Header 3' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0; text-align:left; background:#f8fafc;' } }
                                        ] }
                                    ]
                                },
                                {
                                    tagName: 'tbody',
                                    components: [
                                        { tagName: 'tr', components: [
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 1' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } },
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 2' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } },
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 3' }], attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } }
                                        ] },
                                        { tagName: 'tr', components: [
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 1' }] , attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } },
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 2' }] , attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } },
                                            { type:'cell', components:[{ type:'textnode', content:'Cell 3' }] , attributes: { style: 'padding:12px; border:1px solid #e2e8f0;' } }
                                        ] }
                                    ]
                                }
                            ],
                            style: { width: '100%', borderCollapse: 'collapse' }
                        }
                    });

                    // PRICELIST -> make this a proper comparison/pricelist table (fully editable)
                    bm.add('pricelist-tpl', {
                        label: 'Pricelist / Comparison',
                        category: 'Content',
                        attributes: { class: 'ph ph-tag' },
                        content: {
                            type: 'table',
                            components: [
                                {
                                    tagName: 'thead',
                                    components: [
                                        { tagName: 'tr', components: [
                                            { type:'cell', tagName: 'th', components:[{ type:'textnode', content:'Plan' }], attributes: { style: 'padding:14px; border:1px solid #e6edf3; background:#f8fafc; text-align:left; font-weight:700;' } },
                                            { type:'cell', tagName: 'th', components:[{ type:'textnode', content:'Basic' }], attributes: { style: 'padding:14px; border:1px solid #e6edf3; background:#fff; text-align:center; font-weight:700;' } },
                                            { type:'cell', tagName: 'th', components:[{ type:'textnode', content:'Pro' }], attributes: { style: 'padding:14px; border:1px solid #e6edf3; background:#fff; text-align:center; font-weight:700;' } },
                                            { type:'cell', tagName: 'th', components:[{ type:'textnode', content:'Enterprise' }], attributes: { style: 'padding:14px; border:1px solid #e6edf3; background:#fff; text-align:center; font-weight:700;' } }
                                        ] }
                                    ]
                                },
                                {
                                    tagName: 'tbody',
                                    components: [
                                        // Price row
                                        { tagName: 'tr', components: [
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Price' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; font-weight:600;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Rp 99.000' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Rp 199.000' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center; background:#f0f9ff;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Custom' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } }
                                        ] },
                                        // Feature rows (editable)
                                        { tagName: 'tr', components: [
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Feature A' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Yes' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Yes' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Yes' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } }
                                        ] },
                                        { tagName: 'tr', components: [
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Feature B' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'No' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Yes' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } },
                                            { type:'cell', tagName: 'td', components:[{ type:'textnode', content:'Yes' }], attributes: { style: 'padding:12px; border:1px solid #e6edf3; text-align:center;' } }
                                        ] }
                                    ]
                                }
                            ],
                            style: { width: '100%', borderCollapse: 'collapse', maxWidth: '1000px', margin: '0 auto' }
                        }
                    });

                    bm.add('iconify-blk', { label: 'Iconify', category: 'Media', attributes: { class: 'ph ph-star' }, content: { type: 'iconify-icon' } });
                    
                    // Headers, Content, Widgets (Standard)
                    bm.add('header-1', { label: 'Header Center', category: 'Headers', content: `<header style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:center;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /></header>` });
                    bm.add('header-2', { label: 'Header Left', category: 'Headers', content: `<header style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /><nav><a href="#" style="margin-left:15px;">Home</a></nav></header>` });
                    bm.add('header-3', { label: 'Header Right', category: 'Headers', content: `<header style="padding:15px 20px; display:flex; flex-direction:row-reverse; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /><nav><a href="#" style="margin-right:15px;">Home</a></nav></header>` });
                    bm.add('header-4', { label: 'Header Stack', category: 'Headers', content: `<header style="padding:20px; text-align:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:50px; margin-bottom:15px;" /><nav><a href="#">Home</a></nav></header>` });
                    bm.add('hero-tpl', { label: 'Hero', category: 'Content', content: `<section style="padding:80px 20px; text-align:center; background:#f8fafc;"><h1 style="font-size:3rem; margin-bottom:20px;">Headline</h1><p>Subheadline.</p></section>` });
                    bm.add('video-yt', { label: 'YouTube', category: 'Media', content: { type: 'video', provider: 'yt', style: { height: '350px', width: '100%' } } });
                    bm.add('checkout-pro', { label: 'Checkout', category: 'E-Commerce', content: `<div data-gjs-type="checkout-widget" style="padding:20px; border:2px dashed #3b82f6; text-align:center;"><strong>[ CHECKOUT ]</strong></div>` });

                    // Ensure style manager popovers are attachable (color picker relies on panels)
                    // No further changes to other functions.

                    editor.on('load', () => {
                        editor.Canvas.getBody().style.backgroundColor = '#ffffff';
                        if(this.page.slug) {
                            fetch('/api/admin/pages/'+this.page.slug).then(r=>r.json()).then(d=>{
                                if(d.id) {
                                    this.page.title=d.title; this.page.product_type=d.product_type||'physical';
                                    try{ const c=JSON.parse(d.product_config_json||'{}'); this.page.config={variants:c.variants||[], shipping:c.shipping||{weight:1000}, order_bump:c.order_bump||{active:false,title:'',price:0,desc:''}, coupons:c.coupons||[], settings:c.settings||{}}; }catch(e){this.page.config={variants:[],shipping:{weight:1000},order_bump:{active:false},coupons:[],settings:{}};}
                                    if(d.html_content) editor.setComponents(d.html_content);
                                    if(d.css_content) editor.setStyle(d.css_content);
                                }
                            });
                        }
                    });
                }, 100);
            }
        }
    }
    </script>
</body>
</html>
