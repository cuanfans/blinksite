<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder Pro - Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- GLOBAL RESET --- */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #0f172a; color: #cbd5e1; }
        [x-cloak] { display: none !important; }

        /* --- GRAPESJS UI OVERRIDES (Dark Theme Professional) --- */
        
        /* Hilangkan UI Bawaan yang Jelek */
        .gjs-pn-top-panel, .gjs-pn-views-container, .gjs-pn-views { display: none !important; }
        
        /* Canvas Area */
        .gjs-cv-canvas { width: 100%; height: 100%; top: 0 !important; background-color: #0f172a; }

        /* Custom Panel Containers */
        .panel-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 12px 16px;
            border-bottom: 1px solid #1e293b;
            background: #1e293b;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* GrapesJS Fields Styling */
        .gjs-field { background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; color: white; padding: 4px; }
        .gjs-field input, .gjs-field select { color: white; font-size: 12px; }
        .gjs-field-color-picker { background-color: #1e293b; }
        .gjs-field-arrows { display: none; } /* Hide spinner arrows */
        
        /* Style Manager Sectors */
        .gjs-sm-sector { border-bottom: 1px solid #1e293b; }
        .gjs-sm-title { background-color: #0f172a; color: #e2e8f0; font-size: 12px; font-weight: 600; padding: 10px 16px; border-top: 1px solid #1e293b; cursor: pointer; }
        .gjs-sm-properties { padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .gjs-sm-property { width: 100%; padding: 0; margin-bottom: 8px; }
        .gjs-sm-property__name { color: #94a3b8; font-size: 11px; margin-bottom: 4px; }
        
        /* Set Property Widths like Webflow */
        .gjs-sm-property--width, .gjs-sm-property--height { width: 48%; }
        .gjs-sm-property--display { width: 100%; }
        .gjs-sm-property--font-family { width: 100%; }
        .gjs-sm-property--font-size, .gjs-sm-property--font-weight { width: 48%; }
        .gjs-sm-property--color { width: 100%; }

        /* Block Manager */
        .gjs-blocks-c { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .gjs-block { 
            width: auto; min-height: auto; padding: 12px; 
            background: #1e293b; border: 1px solid #334155; border-radius: 8px; 
            color: #cbd5e1; transition: all 0.2s; box-shadow: none;
            display: flex; flex-col; align-items: center; justify-content: center; gap: 6px;
        }
        .gjs-block:hover { border-color: #3b82f6; background: #1e293b; transform: translateY(-2px); color: white; }
        .gjs-block-label { font-size: 11px; font-weight: 500; }
        .gjs-block i { font-size: 20px; margin-bottom: 4px; }

        /* Layer Manager */
        .gjs-layer-item { background: #0f172a; border-bottom: 1px solid #1e293b; color: #cbd5e1; padding: 8px; }
        .gjs-layer-item.gjs-selected { background: #1e40af !important; color: white; }
        .gjs-layer-vis { color: #64748b; }

        /* Asset Manager Modal Overlay */
        .gjs-am-file-uploader > form { background: #1e293b; border: 2px dashed #475569; }
        .gjs-am-assets-cont { background: #0f172a; }
        .gjs-am-asset { background: #1e293b; border: 1px solid #334155; }
        .gjs-mdl-dialog { background: #1e293b; color: white; border-radius: 12px; border: 1px solid #334155; }
        .gjs-mdl-header { border-bottom: 1px solid #334155; background: #0f172a; }
        .gjs-mdl-title { font-weight: bold; }
        .gjs-mdl-btn-close { color: white; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>

<body class="bg-slate-900 text-white overflow-hidden" x-data="editorApp()">

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-4 z-50 relative">
        <div class="flex items-center gap-4">
            <a href="/admin/pages" class="text-slate-400 hover:text-white transition flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                <i class="ph ph-arrow-left"></i> Dashboard
            </a>
            <div class="h-6 w-px bg-slate-700"></div>
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white w-6 h-6 rounded flex items-center justify-center font-bold text-xs">L</div>
                <span class="font-bold text-sm tracking-tight">LandingBuilder</span>
            </div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700 shadow-sm">
            <button @click="setDevice('Desktop')" :class="device=='Desktop' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-slate-200'" class="p-1.5 rounded transition"><i class="ph ph-desktop"></i></button>
            <button @click="setDevice('Tablet')" :class="device=='Tablet' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-slate-200'" class="p-1.5 rounded transition"><i class="ph ph-device-tablet"></i></button>
            <button @click="setDevice('Mobile')" :class="device=='Mobile' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-slate-200'" class="p-1.5 rounded transition"><i class="ph ph-device-mobile"></i></button>
            <div class="w-px h-4 bg-slate-600 mx-2"></div>
            <button @click="cmd('core:preview')" class="text-slate-400 hover:text-blue-400 p-1.5 transition" title="Preview"><i class="ph ph-eye"></i></button>
            <button @click="cmd('core:undo')" class="text-slate-400 hover:text-white p-1.5 transition"><i class="ph ph-arrow-u-up-left"></i></button>
            <button @click="cmd('core:redo')" class="text-slate-400 hover:text-white p-1.5 transition"><i class="ph ph-arrow-u-up-right"></i></button>
        </div>

        <div class="flex items-center gap-3">
             <div class="flex items-center bg-slate-800 rounded border border-slate-700 overflow-hidden h-8">
                <div class="px-2 text-[10px] text-slate-500 bg-slate-900 h-full flex items-center border-r border-slate-700 font-mono">/</div>
                <input x-model="page.slug" class="bg-transparent text-xs px-2 outline-none w-28 text-white placeholder-slate-600 h-full font-bold" placeholder="slug">
            </div>
            
            <button @click="openSettings" class="text-slate-400 hover:text-white transition"><i class="ph ph-gear text-xl"></i></button>
            
            <button @click="savePage" :disabled="loading" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition shadow-lg shadow-blue-900/20 disabled:opacity-50 border border-blue-500">
                <i x-show="loading" class="ph ph-spinner animate-spin"></i>
                <span x-text="loading ? 'Saving...' : 'Publish'"></span>
            </button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-3.5rem)]">
        
        <div class="w-64 bg-slate-900 border-r border-slate-700 flex flex-col shrink-0 z-20">
            <div class="flex border-b border-slate-700">
                <button @click="leftTab='blocks'" :class="leftTab=='blocks' ? 'text-blue-400 border-b-2 border-blue-500 bg-slate-800' : 'text-slate-500 hover:text-slate-300'" class="flex-1 py-3 text-xs font-bold uppercase transition"><i class="ph ph-plus-square text-lg mr-1 align-middle"></i> Add</button>
                <button @click="leftTab='layers'" :class="leftTab=='layers' ? 'text-blue-400 border-b-2 border-blue-500 bg-slate-800' : 'text-slate-500 hover:text-slate-300'" class="flex-1 py-3 text-xs font-bold uppercase transition"><i class="ph ph-rows text-lg mr-1 align-middle"></i> Layers</button>
            </div>
            
            <div class="flex-1 overflow-y-auto relative">
                <div x-show="leftTab=='blocks'" id="blocks-container" class="absolute inset-0"></div>
                <div x-show="leftTab=='layers'" id="layers-container" class="absolute inset-0"></div>
            </div>
        </div>

        <div class="flex-1 relative bg-slate-950 overflow-hidden flex flex-col">
            <div id="gjs" class="flex-1"></div>
        </div>

        <div class="w-72 bg-slate-900 border-l border-slate-700 flex flex-col shrink-0 z-20">
            <div class="flex border-b border-slate-700">
                <button @click="rightTab='styles'" :class="rightTab=='styles' ? 'text-blue-400 border-b-2 border-blue-500 bg-slate-800' : 'text-slate-500 hover:text-slate-300'" class="flex-1 py-3 text-xs font-bold uppercase transition"><i class="ph ph-paint-brush text-lg mr-1 align-middle"></i> Style</button>
                <button @click="rightTab='traits'" :class="rightTab=='traits' ? 'text-blue-400 border-b-2 border-blue-500 bg-slate-800' : 'text-slate-500 hover:text-slate-300'" class="flex-1 py-3 text-xs font-bold uppercase transition"><i class="ph ph-sliders text-lg mr-1 align-middle"></i> Settings</button>
            </div>

            <div class="flex-1 overflow-y-auto relative">
                <div x-show="rightTab=='styles'" id="styles-container" class="absolute inset-0 pb-10">
                    </div>
                <div x-show="rightTab=='traits'" id="traits-container" class="absolute inset-0 p-4">
                    <div class="text-xs text-slate-500 mb-4 text-center">Select an element to configure settings</div>
                </div>
            </div>
        </div>

    </div>

    <div x-show="modal" x-cloak class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 w-[600px] h-[70vh] rounded-2xl border border-slate-700 shadow-2xl flex overflow-hidden">
            <div class="w-40 bg-slate-800 border-r border-slate-700 p-2 flex flex-col gap-1">
                <button @click="modalTab='product'" :class="modalTab=='product'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'" class="text-left px-3 py-2 rounded-lg text-xs font-bold transition">Product</button>
                <button @click="modalTab='api'" :class="modalTab=='api'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'" class="text-left px-3 py-2 rounded-lg text-xs font-bold transition">API Keys</button>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto relative">
                <button @click="modal=null" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="ph ph-x text-xl"></i></button>
                
                <div x-show="modalTab=='product'" class="space-y-6">
                    <h2 class="text-lg font-bold">Konfigurasi Produk</h2>
                    
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Varian Paket</label>
                            <button @click="addVariant" class="text-blue-400 text-xs font-bold hover:underline">+ Add</button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(v, i) in page.config.variants">
                                <div class="flex gap-2">
                                    <input x-model="v.name" placeholder="Nama" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                                    <input x-model="v.price" type="number" placeholder="Rp" class="w-24 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                                    <button @click="page.config.variants.splice(i,1)" class="text-red-500"><i class="ph ph-trash"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Kupon Diskon</label>
                            <button @click="addCoupon" class="text-blue-400 text-xs font-bold hover:underline">+ Add</button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(c, i) in page.config.coupons">
                                <div class="flex gap-2">
                                    <input x-model="c.code" placeholder="CODE" class="w-24 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs uppercase font-mono text-yellow-500">
                                    <input x-model="c.value" type="number" placeholder="Nilai" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                                    <select x-model="c.type" class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                                        <option value="percent">%</option>
                                        <option value="fixed">Rp</option>
                                    </select>
                                    <button @click="page.config.coupons.splice(i,1)" class="text-red-500"><i class="ph ph-trash"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div x-show="modalTab=='api'" class="space-y-4">
                    <h2 class="text-lg font-bold">API Integration</h2>
                    <p class="text-xs text-slate-400">Simpan API Key untuk Payment & Image Upload.</p>
                    <select x-model="cred.provider" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm mb-2">
                        <option value="midtrans">Midtrans</option>
                        <option value="cloudinary">Cloudinary</option>
                    </select>
                    <textarea x-model="cred.data" class="w-full bg-slate-800 border border-slate-700 p-3 h-32 rounded font-mono text-xs text-slate-300" placeholder='{"server_key":"..."}'></textarea>
                    <button @click="saveCreds" class="bg-blue-600 w-full py-2 rounded text-sm font-bold">Simpan Kredensial</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function editorApp() {
            return {
                loading: false,
                device: 'Desktop',
                leftTab: 'blocks',
                rightTab: 'styles',
                modal: null,
                modalTab: 'product',
                page: { slug: '', title: '', config: { variants:[], coupons:[] } },
                cred: { provider: 'midtrans', data: '' },
                authPass: localStorage.getItem('admin_pass'),

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const slug = urlParams.get('slug');
                    if(slug) this.page.slug = slug;
                    
                    if(!this.authPass) window.location.href = '/login';
                    this.initGrapes();
                },

                setDevice(d) {
                    this.device = d;
                    const cmds = { 'Desktop': 'set-device-desktop', 'Tablet': 'set-device-tablet', 'Mobile': 'set-device-mobile' };
                    if(window.editor) window.editor.runCommand(cmds[d]);
                },

                cmd(c) { window.editor.runCommand(c); },
                openSettings() { this.modal = 'settings'; this.modalTab = 'product'; },

                // Data Logic
                addVariant() { this.page.config.variants.push({ id:Date.now(), name:'', price:0, desc:'' }) },
                addCoupon() { this.page.config.coupons.push({ code:'', type:'percent', value:0 }) },

                async saveCreds() {
                    try {
                        await fetch('/api/admin/credentials', {
                            method: 'POST',
                            headers: { 'Authorization': this.authPass },
                            body: JSON.stringify({ provider: this.cred.provider, data: JSON.parse(this.cred.data) })
                        });
                        alert('Tersimpan!');
                    } catch(e) { alert('JSON Invalid'); }
                },

                async savePage() {
                    if(!this.page.slug) return alert('Slug required');
                    this.loading = true;
                    try {
                        await fetch('/api/admin/pages', {
                            method: 'POST',
                            headers: { 'Authorization': this.authPass },
                            body: JSON.stringify({
                                slug: this.page.slug,
                                title: this.page.title,
                                html: editor.getHtml(),
                                css: editor.getCss(),
                                product_config: this.page.config
                            })
                        });
                        alert('Berhasil disimpan!');
                    } catch(e) { alert('Gagal menyimpan'); }
                    this.loading = false;
                },

                initGrapes() {
                    setTimeout(() => {
                        window.editor = grapesjs.init({
                            container: '#gjs',
                            height: '100%',
                            fromElement: false,
                            storageManager: false,
                            plugins: ['gjs-preset-webpage'],
                            
                            // CONFIGURATION MANAGERS (KUNCI UTAMA)
                            blockManager: { appendTo: '#blocks-container' },
                            layerManager: { appendTo: '#layers-container' },
                            styleManager: { 
                                appendTo: '#styles-container',
                                sectors: [
                                    { name: 'Typography', open: true, buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-align', 'text-decoration'] },
                                    { name: 'Layout', open: false, buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'width', 'height', 'padding', 'margin'] },
                                    { name: 'Background', open: false, buildProps: ['background-color', 'background-image'] },
                                    { name: 'Border', open: false, buildProps: ['border', 'border-radius', 'box-shadow'] }
                                ]
                            },
                            traitManager: { appendTo: '#traits-container' },
                            selectorManager: { appendTo: '#styles-container' }, // Classes
                            
                            // ASSET MANAGER (Custom Upload Header)
                            assetManager: {
                                upload: '/api/admin/upload-image', // API Endpoint
                                uploadName: 'file', // Key di FormData
                                headers: { 'Authorization': this.authPass }, // Auth Header
                                autoAdd: true,
                                openAssetsOnDrop: true
                            }
                        });

                        // CSS Canvas
                        editor.on('load', () => {
                            const body = editor.Canvas.getBody();
                            body.style.backgroundColor = '#0f172a'; // Match theme
                        });

                        // Handle Upload Error/Success Custom (Optional)
                        editor.on('asset:upload:response', (response) => {
                            // API kita mungkin return { url: '...' }, GrapesJS expect array object data
                            // Tapi karena autoAdd: true, dia mencoba parse standar.
                            // Jika API return { url: 'https://...' }, kita perlu manual add jika Grapes gagal
                            console.log('Upload Resp:', response);
                        });

                        // Custom Blocks
                        editor.Blocks.add('checkout-widget', {
                            label: 'ðŸ›’ Checkout Form',
                            category: 'E-Commerce',
                            content: `<div class="p-8 border-2 border-dashed border-blue-500 bg-slate-800 text-center rounded-xl">
                                <h3 class="text-white font-bold text-xl">Checkout Form Placeholder</h3>
                                <p class="text-slate-400 text-sm">Form checkout akan muncul di sini pada halaman live.</p>
                            </div>`
                        });

                        // Load Page Data
                        if(this.page.slug) {
                            fetch('/api/admin/pages/' + this.page.slug)
                                .then(r => r.json())
                                .then(d => {
                                    if(d.id) {
                                        this.page.title = d.title;
                                        this.page.config = d.product_config_json || this.page.config;
                                        if(d.html_content) editor.setComponents(d.html_content);
                                        if(d.css_content) editor.setStyle(d.css_content);
                                    }
                                });
                        }

                    }, 100);
                }
            }
        }
    </script>
</body>
</html>
