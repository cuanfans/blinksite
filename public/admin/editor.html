<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- RESET & BASE --- */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #111827; }
        [x-cloak] { display: none !important; }

        /* --- GRAPESJS OVERRIDES (DARK THEME PROFESIONAL) --- */
        
        /* Hapus Default Top Panel GrapesJS (Kita pakai Header Sendiri) */
        .gjs-pn-top-panel { display: none !important; }

        /* Canvas Area */
        .gjs-cv-canvas {
            background-color: #111827; /* Dark BG */
            top: 0 !important;
            height: 100% !important;
            width: calc(100% - 300px) !important; /* Sisakan ruang untuk panel kanan */
        }

        /* Right Panel (Style/Blocks) */
        .gjs-pn-views-container {
            width: 300px !important;
            right: 0 !important;
            left: auto !important;
            height: 100% !important;
            top: 0 !important;
            background: #1f2937 !important; /* Gray-800 */
            border-left: 1px solid #374151;
            box-shadow: none !important;
            z-index: 10;
        }

        /* Right Panel Tabs (Icon bar) */
        .gjs-pn-views {
            width: 300px !important;
            left: auto !important;
            right: 0 !important;
            border-bottom: 1px solid #374151;
            background: #1f2937;
        }

        .gjs-pn-btn {
            color: #9ca3af !important; /* Gray-400 */
            height: 40px !important;
            margin: 0 !important;
        }
        .gjs-pn-btn.gjs-pn-active {
            color: #60a5fa !important; /* Blue-400 */
            background: #374151 !important;
            box-shadow: none !important;
        }

        /* Input Fields & Labels di Panel */
        .gjs-field { background-color: #374151; border: 1px solid #4b5563; border-radius: 4px; color: white; }
        .gjs-field-color-picker { background-color: #374151; }
        .gjs-label { color: #d1d5db; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .gjs-category-title { background-color: #111827; border-bottom: 1px solid #374151; color: #e5e7eb; font-weight: bold; }
        .gjs-sm-sector .gjs-sm-title { background-color: #1f2937; border-top: 1px solid #374151; font-weight: 600; }

        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Block Manager Icons */
        .gjs-block { border: 1px solid #374151; border-radius: 6px; background: #111827; transition: all 0.2s; }
        .gjs-block:hover { border-color: #60a5fa; color: #60a5fa; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .gjs-block-label { font-size: 11px; font-weight: 500; margin-top: 4px; }

        /* Highlight Selection */
        .gjs-cv-canvas .gjs-highlighter, .gjs-cv-canvas .gjs-selected { outline: 2px solid #60a5fa !important; }
        .gjs-toolbar { background-color: #2563eb !important; border-radius: 4px; top: -30px !important; }
    </style>
</head>

<body class="bg-gray-900 text-white" x-data="app()">

    <div x-show="!isLoggedIn" x-cloak class="fixed inset-0 z-[9999] flex items-center justify-center bg-gray-900/95 backdrop-blur-sm">
        <div class="bg-gray-800 p-8 rounded-xl w-96 border border-gray-700 shadow-2xl text-center">
            <div class="mb-4 text-red-500 text-5xl"><i class="ph ph-lock-key"></i></div>
            <h1 class="text-2xl font-bold mb-2 text-white">Sesi Berakhir</h1>
            <p class="mb-6 text-sm text-gray-400">Keamanan: Silakan login ulang.</p>
            <form @submit.prevent="login">
                <input type="password" x-model="auth.password" placeholder="Password Admin" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 mb-4 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg hover:shadow-blue-500/20">LOGIN KEMBALI</button>
            </form>
            <a href="/admin/dashboard" class="block mt-6 text-gray-500 text-xs hover:text-white underline">Kembali ke Dashboard</a>
        </div>
    </div>

    <div x-show="isLoggedIn" x-cloak class="flex flex-col h-full">
        
        <div class="h-14 bg-gray-900 border-b border-gray-700 flex justify-between items-center px-4 relative z-50 shadow-md shrink-0">
            
            <div class="flex items-center gap-4">
                <a href="/admin/pages" class="text-gray-400 hover:text-white transition flex items-center gap-2 text-sm font-medium">
                    <i class="ph ph-arrow-left text-lg"></i> Back
                </a>
                <div class="h-6 w-px bg-gray-700"></div>
                
                <div class="flex items-center gap-3">
                    <span class="font-bold text-lg text-blue-500 tracking-tight">LandingBuilder <span class="text-xs bg-blue-900/50 text-blue-300 px-1.5 py-0.5 rounded border border-blue-800">PRO</span></span>
                </div>
            </div>

            <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-gray-800 rounded-lg p-1 border border-gray-700">
                <button @click="setDevice('Desktop')" :class="device=='Desktop' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-gray-200'" class="p-1.5 rounded transition" title="Desktop"><i class="ph ph-desktop text-lg"></i></button>
                <button @click="setDevice('Tablet')" :class="device=='Tablet' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-gray-200'" class="p-1.5 rounded transition" title="Tablet"><i class="ph ph-device-tablet text-lg"></i></button>
                <button @click="setDevice('Mobile')" :class="device=='Mobile' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-gray-200'" class="p-1.5 rounded transition" title="Mobile"><i class="ph ph-device-mobile text-lg"></i></button>
                
                <div class="w-px h-4 bg-gray-600 mx-2"></div>
                
                <button @click="cmd('core:undo')" class="text-gray-400 hover:text-white p-1.5 transition" title="Undo"><i class="ph ph-arrow-u-up-left text-lg"></i></button>
                <button @click="cmd('core:redo')" class="text-gray-400 hover:text-white p-1.5 transition" title="Redo"><i class="ph ph-arrow-u-up-right text-lg"></i></button>
                <button @click="cmd('core:component-outline')" class="text-gray-400 hover:text-blue-400 p-1.5 transition" title="Toggle Borders"><i class="ph ph-bounding-box text-lg"></i></button>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center bg-gray-800 rounded border border-gray-700 overflow-hidden h-8">
                    <div class="px-3 text-xs text-gray-500 bg-gray-900 h-full flex items-center border-r border-gray-700">slug</div>
                    <input x-model="page.slug" placeholder="halaman-saya" class="bg-transparent text-sm px-3 outline-none w-32 text-white placeholder-gray-600 font-mono h-full">
                </div>

                <button @click="modal='product'" class="bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                    <i class="ph ph-package"></i> Produk
                </button>
                <button @click="modal='settings'" class="bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                    <i class="ph ph-plugs"></i> API
                </button>
                
                <button @click="savePage" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-1.5 rounded text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-900/50 hover:-translate-y-0.5 transition transform border border-blue-500">
                    <i x-show="!loading" class="ph ph-floppy-disk text-lg"></i>
                    <i x-show="loading" class="ph ph-spinner animate-spin text-lg"></i>
                    <span x-text="loading ? 'Menyimpan...' : 'Simpan'"></span>
                </button>
                
                <button @click="previewPage" class="text-gray-400 hover:text-white p-2 transition" title="Lihat Live"><i class="ph ph-eye text-xl"></i></button>
            </div>
        </div>

        <div class="flex-grow relative overflow-hidden">
            <div id="gjs" class="absolute inset-0"></div>
        </div>
    </div>

    <div x-show="modal==='product'" x-cloak class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" @click.self="modal=null">
        <div class="bg-gray-900 text-white w-full max-w-4xl h-[80vh] rounded-2xl flex overflow-hidden shadow-2xl border border-gray-700">
            <div class="w-56 bg-gray-800 border-r border-gray-700 p-4 flex flex-col gap-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 px-2">Menu Produk</h3>
                <button @click="tab='variants'" :class="tab=='variants'?'bg-blue-600 text-white shadow':'text-gray-400 hover:bg-gray-700 hover:text-white'" class="text-left px-4 py-3 rounded-lg text-sm font-bold transition flex items-center gap-3"><i class="ph ph-tag"></i> Varian Paket</button>
                <button @click="tab='bump'" :class="tab=='bump'?'bg-blue-600 text-white shadow':'text-gray-400 hover:bg-gray-700 hover:text-white'" class="text-left px-4 py-3 rounded-lg text-sm font-bold transition flex items-center gap-3"><i class="ph ph-plus-circle"></i> Order Bump</button>
                <button @click="tab='coupons'" :class="tab=='coupons'?'bg-blue-600 text-white shadow':'text-gray-400 hover:bg-gray-700 hover:text-white'" class="text-left px-4 py-3 rounded-lg text-sm font-bold transition flex items-center gap-3"><i class="ph ph-ticket"></i> Kupon Diskon</button>
            </div>
            <div class="flex-grow p-8 overflow-y-auto bg-gray-900">
                
                <div x-show="tab=='variants'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Varian Produk</h2>
                        <button @click="addVariant" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition"><i class="ph ph-plus"></i> Tambah</button>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(v, i) in page.config.variants">
                            <div class="p-4 rounded-xl bg-gray-800 border border-gray-700 grid grid-cols-12 gap-4 items-center group">
                                <div class="col-span-1 text-center text-gray-500 font-mono text-xs" x-text="i+1"></div>
                                <div class="col-span-4">
                                    <label class="text-[10px] text-gray-500 uppercase font-bold">Nama Paket</label>
                                    <input x-model="v.name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                                </div>
                                <div class="col-span-3">
                                    <label class="text-[10px] text-gray-500 uppercase font-bold">Harga (Rp)</label>
                                    <input x-model="v.price" type="number" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                                </div>
                                <div class="col-span-3">
                                    <label class="text-[10px] text-gray-500 uppercase font-bold">Deskripsi Singkat</label>
                                    <input x-model="v.desc" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                                </div>
                                <div class="col-span-1 text-right">
                                    <button @click="page.config.variants.splice(i,1)" class="text-red-500 hover:bg-red-900/50 p-2 rounded transition"><i class="ph ph-trash"></i></button>
                                </div>
                            </div>
                        </template>
                        <div x-show="page.config.variants.length === 0" class="text-center py-10 text-gray-600 border-2 border-dashed border-gray-800 rounded-xl">
                            Belum ada varian produk.
                        </div>
                    </div>
                </div>

                <div x-show="tab=='bump'" class="max-w-lg">
                    <h2 class="text-xl font-bold mb-6">Order Bump (Upsell)</h2>
                    <label class="flex items-center gap-3 p-4 border border-gray-700 rounded-xl bg-gray-800 cursor-pointer hover:border-blue-500 transition mb-6">
                        <input type="checkbox" x-model="page.config.order_bump.active" class="w-5 h-5 accent-blue-600 rounded">
                        <span class="font-bold text-gray-200">Aktifkan Penawaran Tambahan di Checkout</span>
                    </label>
                    <div x-show="page.config.order_bump.active" class="space-y-4 pl-1">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nama Produk Tambahan</label>
                            <input x-model="page.config.order_bump.product_name" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Harga Tambahan (Rp)</label>
                            <input x-model="page.config.order_bump.price" type="number" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Kalimat Penawaran (Persuasif)</label>
                            <textarea x-model="page.config.order_bump.description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none"></textarea>
                        </div>
                    </div>
                </div>

                <div x-show="tab=='coupons'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Kupon Diskon</h2>
                        <button @click="addCoupon" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition"><i class="ph ph-plus"></i> Buat Kupon</button>
                    </div>
                    <template x-for="(c, i) in page.config.coupons">
                        <div class="flex gap-3 mb-3 items-center bg-gray-800 p-3 rounded-lg border border-gray-700">
                            <div class="bg-gray-900 px-3 py-2 rounded font-mono text-yellow-400 font-bold tracking-wider border border-gray-700">
                                <input x-model="c.code" class="bg-transparent outline-none uppercase w-24 text-center" placeholder="KODE">
                            </div>
                            <select x-model="c.type" class="bg-gray-900 border border-gray-700 text-white rounded px-3 py-2 text-sm outline-none">
                                <option value="percent">Persen (%)</option>
                                <option value="fixed">Potongan (Rp)</option>
                            </select>
                            <input x-model="c.value" type="number" class="bg-gray-900 border border-gray-700 text-white rounded px-3 py-2 text-sm w-32 outline-none" placeholder="Nilai">
                            <button @click="page.config.coupons.splice(i,1)" class="ml-auto text-gray-500 hover:text-red-500 p-2"><i class="ph ph-x-circle text-xl"></i></button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div x-show="modal==='settings'" x-cloak class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center" @click.self="modal=null">
        <div class="bg-gray-800 text-white w-96 p-6 rounded-xl border border-gray-700 shadow-2xl">
            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="ph ph-key"></i> Quick API Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Provider</label>
                    <select x-model="cred.provider" class="w-full bg-gray-900 border border-gray-700 p-2.5 rounded-lg text-sm outline-none">
                        <option value="midtrans">Midtrans Payment</option>
                        <option value="cloudinary">Cloudinary Images</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">JSON Data</label>
                    <textarea x-model="cred.data" class="w-full bg-gray-900 border border-gray-700 p-3 h-32 text-xs font-mono rounded-lg outline-none text-gray-300" placeholder='{"server_key":"SB-Mid-..."}'></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button @click="modal=null" class="text-sm text-gray-400 hover:text-white transition">Batal</button>
                <button @click="saveCreds" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">Simpan Kredensial</button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false, 
                loading: false, 
                modal: null, 
                tab: 'variants',
                device: 'Desktop', // Desktop, Tablet, Mobile
                
                auth: { password: '' },
                page: { slug: '', title: '', config: { variants:[], coupons:[], order_bump:{active:false} } },
                cred: { provider: 'midtrans', data: '' },

                init() { 
                    const p = localStorage.getItem('admin_pass'); 
                    // Cek URL Params untuk Slug
                    const urlParams = new URLSearchParams(window.location.search);
                    const slugParam = urlParams.get('slug');
                    if(slugParam) this.page.slug = slugParam;

                    if(p) { this.auth.password=p; this.verify(); } 
                },

                async verify() { 
                    try { 
                        const r = await fetch('/api/login', { method: 'POST', body: JSON.stringify({password: this.auth.password}) }); 
                        if((await r.json()).success) { 
                            this.isLoggedIn = true; 
                            localStorage.setItem('admin_pass', this.auth.password); 
                            this.initGrapes(); 
                        } 
                    } catch(e){} 
                },
                
                async login() { if(this.auth.password) await this.verify(); },

                // Helper Functions
                setDevice(d) {
                    this.device = d;
                    if(d==='Desktop') window.editor.runCommand('set-device-desktop');
                    if(d==='Tablet') window.editor.runCommand('set-device-tablet');
                    if(d==='Mobile') window.editor.runCommand('set-device-mobile');
                },
                cmd(c) { window.editor.runCommand(c); },

                // Product Logic
                addVariant() { this.page.config.variants.push({ id:Date.now(), name:'', price:0, desc:'' }) },
                addCoupon() { this.page.config.coupons.push({ code:'', type:'percent', value:0 }) },
                
                async saveCreds() { 
                    try { 
                        await fetch('/api/admin/credentials', { method:'POST', headers:{'Authorization':this.auth.password}, body:JSON.stringify({provider:this.cred.provider, data:JSON.parse(this.cred.data)}) }); 
                        alert('Kredensial tersimpan aman!'); this.modal=null; 
                    } catch(e){ alert('Format JSON Salah!'); } 
                },

                async savePage() { 
                    if(!this.page.slug) return alert('Slug tidak boleh kosong!'); 
                    this.loading = true; 
                    try {
                        await fetch('/api/admin/pages', {
                            method: 'POST',
                            headers: { 'Authorization': this.auth.password },
                            body: JSON.stringify({
                                slug: this.page.slug, 
                                title: this.page.title, 
                                html: editor.getHtml(), 
                                css: editor.getCss(), 
                                product_config: this.page.config
                            })
                        });
                        alert('Halaman Berhasil Disimpan! ðŸš€'); 
                    } catch(e) { alert('Gagal menyimpan.'); }
                    this.loading = false; 
                },

                previewPage() { if(this.page.slug) window.open('/'+this.page.slug, '_blank'); },

                initGrapes() {
                    setTimeout(() => {
                        window.editor = grapesjs.init({
                            container: '#gjs',
                            height: '100%',
                            fromElement: false,
                            storageManager: false,
                            plugins: ['gjs-preset-webpage'],
                            pluginsOpts: {
                                'gjs-preset-webpage': {
                                    modalImportTitle: 'Import',
                                    modalImportLabel: '<div style="margin-bottom: 10px; font-size: 13px;">Paste HTML here</div>',
                                    modalImportContent: '',
                                }
                            },
                            // PANEL CONFIG (Kita sembunyikan top panel lewat CSS, tapi biarkan block manager dll)
                            panels: { defaults: [] }, 
                            deviceManager: {
                                devices: [
                                    { name: 'Desktop', width: '' },
                                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                                    { name: 'Mobile', width: '320px', widthMedia: '480px' },
                                ]
                            },
                            blockManager: {
                                appendTo: '#blocks', // Default
                            }
                        });

                        // Tambahkan CSS Custom ke Canvas agar sesuai tema
                        editor.on('load', () => {
                            const body = editor.Canvas.getBody();
                            body.style.backgroundColor = '#111827'; // Dark canvas
                            body.style.color = '#fff';
                        });

                        // WIDGET KHUSUS: CHECKOUT FORM
                        editor.Blocks.add('checkout-pro', { 
                            label: '<div class="flex items-center gap-2"><i class="fa fa-shopping-cart"></i> Checkout Form</div>', 
                            category: 'E-COMMERCE', 
                            attributes: { class:'gjs-fonts gjs-f-b1' }, 
                            content: `
                            <div style="padding:40px 20px; text-align:center; border:2px dashed #3b82f6; background:#1e293b; color:#94a3b8; border-radius:12px; font-family:sans-serif;">
                                <div style="font-size:40px; margin-bottom:10px;">ðŸ›’</div>
                                <h3 style="color:white; margin:0 0 10px 0;">Checkout Form Area</h3>
                                <p style="font-size:12px;">Form checkout lengkap (Nama, WA, Kurir, Payment) akan muncul otomatis di sini saat halaman dibuka oleh pembeli.</p>
                            </div>
                        `});

                        // Load Data Halaman
                        if(this.page.slug) {
                            fetch('/api/admin/pages/'+this.page.slug)
                                .then(r=>r.json())
                                .then(d => {
                                    if(d.id) { 
                                        this.page.title = d.title; 
                                        this.page.config = d.product_config_json || this.page.config; 
                                        if(d.html_content) editor.setComponents(d.html_content); 
                                        if(d.css_content) editor.setStyle(d.css_content); 
                                    }
                                });
                        }
                    }, 100); // Delay sedikit agar DOM siap
                }
            }
        }
    </script>
</body>
</html>
