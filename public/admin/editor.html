<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandingBuilder - Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/grapesjs@0.21.2/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs@0.21.2/dist/grapes.min.js"></script>
    
    <script src="https://unpkg.com/grapesjs-blocks-basic@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-plugin-forms@2.0.5"></script>
    <script src="https://unpkg.com/grapesjs-navbar@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-component-countdown@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-tabs@1.0.6"></script>
    <script src="https://unpkg.com/grapesjs-custom-code@1.0.1"></script>
    <script src="https://unpkg.com/grapesjs-tooltip@0.1.7"></script>
    <script src="https://unpkg.com/grapesjs-blocks-flexbox@0.1.1"></script>
    <script src="https://unpkg.com/grapesjs-plugin-export@1.0.11"></script>
    <script src="https://unpkg.com/grapesjs-typed@1.0.5"></script>
    <script src="https://unpkg.com/grapesjs-style-bg@2.0.1"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* RESET & BASE */
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #fff; color: #1e293b; }
        [x-cloak] { display: none !important; }
        
        /* GRAPESJS UI OVERRIDES */
        .gjs-pn-top-panel, .gjs-pn-views-container, .gjs-pn-views { display: none !important; }
        
        /* FIX: Pindahkan .gjs-pn-panels ke bawah kanan jauh dari tombol */
        .gjs-pn-panels { 
            position: fixed !important; 
            bottom: 10px !important; 
            right: 330px !important;
            top: auto !important; 
            left: auto !important;
            width: auto !important; 
            height: auto !important; 
            z-index: 8888 !important; 
            overflow: visible !important;
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* Ensure all children dapat diklik dan visible */
        .gjs-pn-panels * { 
            pointer-events: auto !important; 
            visibility: visible !important;
        }
        
        /* Color picker popover harus visible dan accessible */
        .gjs-color-picker-content,
        .gjs-field-color-picker,
        .gjs-color-picker {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Popover/dropdown styling */
        .gjs-popover {
            z-index: 10000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
        }

        .gjs-cv-canvas { width: 100%; height: 100%; top: 0 !important; background-color: #f8fafc; }
        .gjs-selected { outline: 2px solid #2563eb !important; outline-offset: -2px; }
        
        /* INPUTS & COLOR PICKER */
        .input-std { width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px; font-size: 12px; outline: none; transition: border-color 0.2s; }
        .input-std:focus { border-color: #2563eb; }
        .gjs-field-color-picker { width: 100%; min-width: 30px; height: 25px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* PANEL UI */
        .panel-tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .panel-tabs button { flex: 1; padding: 12px; color: #94a3b8; font-size: 20px; transition: all 0.2s; }
        .panel-tabs button:hover { color: #334155; background: #f8fafc; }
        .panel-tabs button.active { color: #2563eb; border-bottom: 2px solid #2563eb; background: #eff6ff; }
        
        /* BLOCKS */
        .gjs-blocks-c { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px; background: #fff; }
        .gjs-block { width: 100% !important; min-height: auto !important; padding: 15px 5px !important; margin: 0 !important; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: grab; transition: all 0.15s; }
        .gjs-block:hover { border-color: #3b82f6; color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .gjs-block-label { font-size: 10px; font-weight: 600; text-align: center; margin-top: 4px; color: #475569; }
        .gjs-block-category .gjs-title { background: #f8fafc; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 8px 12px; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }

        /* RESPONSIVE EDITOR - MOBILE ONLY */
        @media (max-width: 768px) {
            /* Sidebar menjadi bottom sheet di mobile */
            .sidebar-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 0;
                background: white;
                border-top: 1px solid #e2e8f0;
                z-index: 30;
                overflow: hidden;
                transition: height 0.3s ease;
            }

            .sidebar-panel.active {
                height: 70vh;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            }

            .sidebar-panel .panel-tabs {
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
                display: flex;
            }

            .sidebar-panel .panel-content {
                height: calc(70vh - 56px);
                overflow-y: auto;
            }

            /* Bottom navigation untuk mobile */
            .bottom-editor-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 56px;
                background: white;
                border-top: 1px solid #e2e8f0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 25;
            }

            .bottom-editor-nav button {
                flex: 1;
                height: 100%;
                border: none;
                background: none;
                color: #94a3b8;
                font-size: 20px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .bottom-editor-nav button.active {
                color: #2563eb;
                border-top: 2px solid #2563eb;
            }

            .bottom-editor-nav button:hover {
                color: #334155;
            }

            /* Add margin di canvas untuk bottom nav */
            #gjs {
                margin-bottom: 56px !important;
            }

            /* Sembunyikan sidebar desktop di mobile */
            .sidebar-desktop {
                display: none !important;
            }

            /* Simplify header di mobile */
            .header-slug-section {
                display: none;
            }

            .header-device-section {
                display: none;
            }

            header .flex.items-center.gap-3 {
                gap: 8px;
            }

            header button[class*="px-3"] {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Settings panel responsive */
            .settings-modal {
                width: 100vw;
                max-width: 100vw;
            }

            .gjs-pn-panels {
                right: 56px !important;
            }
        }
    </style>
</head>

<body x-data="editorApp()">

    <div class="fixed bottom-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none">
        <template x-for="n in notifications" :key="n.id">
            <div x-show="n.show" x-transition class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border-l-4 bg-white min-w-[250px]" :class="n.type==='success'?'border-green-500':'border-red-500'">
                <i class="ph text-xl" :class="n.type==='success'?'ph-check-circle text-green-500':'ph-warning-circle text-red-500'"></i>
                <div><h4 class="text-xs font-bold text-gray-800" x-text="n.title"></h4><p class="text-[10px] text-gray-500" x-text="n.msg"></p></div>
            </div>
        </template>
    </div>

    <div id="iconify-picker-modal" class="fixed inset-0 hidden z-[99999] bg-black/40 flex items-start justify-center p-6 backdrop-blur-sm">
      <div class="bg-white rounded-lg w-full max-w-2xl shadow-2xl overflow-hidden mt-10">
        <div class="flex items-center justify-between p-4 border-b bg-gray-50">
          <div class="flex items-center gap-2 w-full">
            <i class="ph ph-magnifying-glass text-lg text-gray-500"></i>
            <input id="iconify-picker-search" placeholder="Cari icon, mis. ph:heart atau hanya 'heart'" class="w-full bg-transparent outline-none text-sm ml-2" />
            <button id="iconify-picker-clear" class="ml-2 text-xs font-bold text-gray-400 hover:text-red-500">CLEAR</button>
          </div>
          <button id="iconify-picker-close" class="ml-4 text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
        </div>
        <div id="iconify-picker-results" class="p-4 grid grid-cols-6 gap-3 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="col-span-full text-center text-gray-400 text-xs py-8">Ketik pencarian di atas...</div>
        </div>
        <div class="p-3 text-[10px] text-gray-400 border-t bg-gray-50 flex justify-between">
            <span>Tip: Double-click icon di canvas untuk mengganti.</span>
            <span class="font-mono">Powered by Iconify</span>
        </div>
      </div>
    </div>

    <header class="h-14 bg-white border-b border-gray-200 flex justify-between items-center px-4 z-50 relative shrink-0">
        <div class="flex items-center gap-4">
            <a href="/admin/pages" class="text-gray-400 hover:text-blue-600 transition"><i class="ph ph-arrow-left text-xl"></i></a>
            <div class="h-6 w-px bg-gray-200 header-slug-section"></div>
            <div class="header-slug-section"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">Page Slug</span><input x-model="page.slug" class="bg-transparent font-mono font-bold text-sm text-gray-700 outline-none w-48 placeholder-gray-300" placeholder="nama-halaman"></div>
        </div>
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 header-device-section">
            <button @click="setDevice('desktop')" :class="device=='desktop'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-desktop text-lg"></i></button>
            <button @click="setDevice('tablet')" :class="device=='tablet'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-device-tablet text-lg"></i></button>
            <button @click="setDevice('mobile')" :class="device=='mobile'?'bg-white shadow-sm text-blue-600':'text-gray-400'" class="p-2 rounded-md transition"><i class="ph ph-device-mobile text-lg"></i></button>
            <div class="w-px h-5 bg-gray-300 mx-2"></div>
            <button @click="cmd('core:preview')" class="text-gray-500 hover:text-blue-600 p-2"><i class="ph ph-eye text-lg"></i></button>
            <button @click="cmd('core:undo')" class="text-gray-400 hover:text-gray-700 p-2"><i class="ph ph-arrow-u-up-left text-lg"></i></button>
            <button @click="cmd('core:redo')" class="text-gray-400 hover:text-gray-700 p-2"><i class="ph ph-arrow-u-up-right text-lg"></i></button>
        </div>
        <div class="flex items-center gap-3">
            <button @click="cmd('gjs-export-zip')" class="text-gray-500 hover:text-green-600 flex items-center gap-1 text-xs font-bold px-2 hidden md:flex"><i class="ph ph-download-simple text-lg"></i> ZIP</button>
            <button @click="showSettings=true" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-3 py-2 rounded-md text-xs font-bold flex items-center gap-2 border border-gray-200 hidden md:flex"><i class="ph ph-gear-six text-lg"></i> Settings</button>
            <button @click="savePage" :disabled="loading" class="bg-blue-600 hover:bg-blue-700 text-white px-3 md:px-5 py-2 rounded-md text-xs font-bold transition flex items-center gap-2 disabled:opacity-50 shadow-lg shadow-blue-500/30"><i x-show="loading" class="ph ph-spinner animate-spin"></i><span x-text="loading ? 'SAVING...' : 'PUBLISH'"></span></button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-3.5rem)] overflow-hidden">
        <div class="flex-1 relative bg-[#f8fafc] flex flex-col items-center justify-center p-8 overflow-hidden">
            <div id="gjs" class="flex-1 w-full h-full shadow-xl rounded-lg overflow-hidden border border-gray-300 bg-white ring-4 ring-gray-100"></div>
        </div>
        <!-- SIDEBAR DESKTOP - hanya muncul di desktop -->
        <div class="sidebar-desktop w-[320px] bg-white border-l border-gray-200 flex flex-col z-20 shrink-0 shadow-[0_0_20px_rgba(0,0,0,0.05)]">
            <div class="panel-tabs">
                <button @click="tab='blocks'" :class="tab=='blocks'?'active':''" title="Elements"><i class="ph ph-plus-square"></i></button>
                <button @click="tab='styles'" :class="tab=='styles'?'active':''" title="Style"><i class="ph ph-paint-brush"></i></button>
                <button @click="tab='traits'" :class="tab=='traits'?'active':''" title="Settings"><i class="ph ph-sliders"></i></button>
                <button @click="tab=='layers'" :class="tab=='layers'?'active':''" title="Layers"><i class="ph ph-tree-structure"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-white relative custom-scroll">
                <div x-show="tab=='blocks'" id="blocks-container" class="absolute inset-0 pb-20"></div>
                <div x-show="tab=='styles'"><div id="selectors-container" class="p-3 border-b bg-gray-50"></div><div id="styles-container" class="pb-20"></div></div>
                <div x-show="tab=='traits'"><div class="p-3 bg-gray-50 text-gray-500 text-[10px] font-bold uppercase tracking-widest border-b">Settings</div><div id="traits-container" class="p-2 pb-20"></div></div>
                <div x-show="tab=='layers'" id="layers-container" class="absolute inset-0 pb-20"></div>
            </div>
        </div>

        <!-- MOBILE BOTTOM SHEET PANEL -->
        <div class="sidebar-panel" :class="mobileTab ? 'active' : ''">
            <div class="panel-tabs">
                <button @click="mobileTab='blocks'" :class="mobileTab=='blocks'?'active':''" title="Elements"><i class="ph ph-plus-square"></i></button>
                <button @click="mobileTab='styles'" :class="mobileTab=='styles'?'active':''" title="Style"><i class="ph ph-paint-brush"></i></button>
                <button @click="mobileTab='traits'" :class="mobileTab=='traits'?'active':''" title="Settings"><i class="ph ph-sliders"></i></button>
                <button @click="mobileTab='layers'" :class="mobileTab=='layers'?'active':''" title="Layers"><i class="ph ph-tree-structure"></i></button>
            </div>
            <div class="panel-content">
                <div x-show="mobileTab=='blocks'" id="blocks-container-mobile" class="p-2"></div>
                <div x-show="mobileTab=='styles'"><div id="selectors-container-mobile" class="p-3 border-b bg-gray-50"></div><div id="styles-container-mobile" class="pb-20"></div></div>
                <div x-show="mobileTab=='traits'"><div class="p-3 bg-gray-50 text-gray-500 text-[10px] font-bold uppercase tracking-widest border-b">Settings</div><div id="traits-container-mobile" class="p-2 pb-20"></div></div>
                <div x-show="mobileTab=='layers'" id="layers-container-mobile" class="p-2"></div>
            </div>
        </div>

        <!-- MOBILE BOTTOM NAV -->
        <div class="bottom-editor-nav">
            <button @click="mobileTab='blocks'" :class="mobileTab=='blocks'?'active':''"><i class="ph ph-plus-square"></i></button>
            <button @click="mobileTab='styles'" :class="mobileTab=='styles'?'active':''"><i class="ph ph-paint-brush"></i></button>
            <button @click="mobileTab='traits'" :class="mobileTab=='traits'?'active':''"><i class="ph ph-sliders"></i></button>
            <button @click="mobileTab='layers'" :class="mobileTab=='layers'?'active':''"><i class="ph ph-tree-structure"></i></button>
            <button @click="showSettings=true"><i class="ph ph-gear-six"></i></button>
        </div>
    </div>

    <div x-show="showSettings" x-cloak class="fixed inset-0 z-[200] bg-slate-900/50 backdrop-blur-sm flex justify-end" @click.self="showSettings = false">
        <div class="settings-modal w-[400px] h-full bg-white shadow-2xl flex flex-col" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-gray-800 flex items-center gap-2"><i class="ph ph-faders text-blue-600"></i> Page Configuration</h2>
                <button @click="showSettings = false" class="text-gray-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
                <div><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Product</h3><div class="flex bg-gray-100 p-1 rounded-lg mb-4"><button @click="page.product_type='physical'" :class="page.product_type=='physical'?'bg-white shadow text-blue-600':''" class="flex-1 py-1.5 text-xs font-bold rounded-md transition">PHYSICAL</button><button @click="page.product_type='digital'" :class="page.product_type=='digital'?'bg-white shadow text-blue-600':''" class="flex-1 py-1.5 text-xs font-bold rounded-md transition">DIGITAL</button></div><div x-show="page.product_type==='physical'"><label class="text-[11px] font-bold text-gray-600">Weight (gram)</label><input x-model="page.config.shipping.weight" type="number" class="input-std mt-1"></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Variants</h3><div class="space-y-2"><template x-for="(v, i) in page.config.variants"><div class="flex gap-2 items-center"><input x-model="v.name" class="input-std flex-1" placeholder="Name"><input x-model="v.price" type="number" class="input-std w-24" placeholder="Price"><button @click="page.config.variants.splice(i,1)" class="text-red-400 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></template><button @click="addVariant" class="w-full border-2 border-dashed border-gray-300 text-gray-500 font-bold text-xs py-2 rounded hover:border-blue-400 transition">+ Add Variant</button></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-3">Order Bump</h3><div class="flex items-center gap-2 mb-2"><input type="checkbox" x-model="page.config.order_bump.active"><span class="text-xs">Aktif</span></div><div x-show="page.config.order_bump.active" class="space-y-3 bg-purple-50 p-4 rounded-lg border border-purple-100"><input x-model="page.config.order_bump.title" class="input-std" placeholder="Title"><input x-model="page.config.order_bump.price" type="number" class="input-std" placeholder="Price"><textarea x-model="page.config.order_bump.desc" class="input-std" rows="2" placeholder="Desc"></textarea></div></div>
                <div class="border-t pt-6"><h3 class="text-xs font-bold text-red-500 uppercase tracking-wider mb-3">Coupons</h3><template x-for="(c, i) in page.config.coupons"><div class="bg-red-50 p-2 mb-2 rounded border border-red-100 flex gap-2"><input x-model="c.code" class="input-std" placeholder="CODE"><input x-model="c.value" type="number" class="input-std w-20" placeholder="Val"><button @click="page.config.coupons.splice(i,1)" class="text-red-500"><i class="ph ph-x"></i></button></div></template><button @click="page.config.coupons.push({code:'', type:'percent', value:0})" class="w-full py-2 text-xs font-bold text-red-500 border border-red-200 rounded hover:bg-red-50 transition">+ Add Coupon</button></div>
                <div class="border-t pt-6 space-y-4"><h3 class="text-xs font-bold text-green-600 uppercase tracking-wider">SEO</h3><div><label class="text-[10px] font-bold text-gray-500">Title</label><input x-model="page.config.settings.seo_title" class="input-std"></div><div><label class="text-[10px] font-bold text-gray-500">Desc</label><textarea x-model="page.config.settings.seo_description" class="input-std" rows="2"></textarea></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-gray-500">Favicon</label><input x-model="page.config.settings.favicon" class="input-std"></div><div><label class="text-[10px] font-bold text-gray-500">OG Image</label><input x-model="page.config.settings.og_image" class="input-std"></div></div></div>
                <div class="border-t pt-6 bg-gray-50 -mx-6 px-6 pb-6"><h3 class="text-xs font-bold text-gray-800 uppercase tracking-wider mb-3 pt-4">API</h3><select x-model="cred.provider" class="input-std mb-2 bg-white"><option value="midtrans">Midtrans</option><option value="cloudinary">Cloudinary</option></select><textarea x-model="cred.data" class="input-std font-mono text-[10px] bg-white" rows="3" placeholder='JSON Config'></textarea><button @click="saveCreds" class="w-full bg-gray-800 text-white py-2 rounded mt-3 text-xs font-bold hover:bg-black transition">Save</button></div>
            </div>
        </div>
    </div>

    <script>
    // --- 1. ICONIFY PICKER LOGIC (UNCHANGED) ---
    (function(){
      let iconifyPickerState = { model: null };
      const modal = document.getElementById('iconify-picker-modal');
      const input = document.getElementById('iconify-picker-search');
      const results = document.getElementById('iconify-picker-results');
      const closeBtn = document.getElementById('iconify-picker-close');
      const clearBtn = document.getElementById('iconify-picker-clear');

      window.openIconifyPicker = function(model){
        iconifyPickerState.model = model || null;
        modal.classList.remove('hidden');
        input.focus();
        try {
          const cur = model && model.get ? (model.get('attributes') || {}).icon : '';
          input.value = cur || '';
          if(cur) doSearch(cur); 
        } catch(e){ input.value=''; }
      };

      function closeIconifyPicker(){
        modal.classList.add('hidden');
        iconifyPickerState.model = null;
        results.innerHTML = '<div class="col-span-full text-center text-gray-400 text-xs py-8">Ketik pencarian di atas...</div>';
      }

      function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

      async function searchIconify(q){
        if(!q) return [];
        const plain = q.includes(':') ? q.split(':').pop() : q;
        const qEnc = encodeURIComponent(plain);
        try {
          const res = await fetch(`https://api.iconify.design/search?query=${qEnc}&limit=24`);
          if(!res.ok) return [];
          const json = await res.json();
          if(Array.isArray(json.icons)) return json.icons;
          return [];
        } catch(e){ return []; }
      }

      function renderResults(list){
        results.innerHTML = '';
        if(!list || list.length===0){
          results.innerHTML = `<div class="col-span-6 text-sm text-gray-500 text-center">Tidak ada hasil</div>`;
          return;
        }
        list.forEach(iconName=>{
          const btn = document.createElement('button');
          btn.className = 'flex flex-col items-center gap-1 p-2 rounded hover:bg-blue-50 border border-transparent hover:border-blue-200 transition';
          btn.innerHTML = `<iconify-icon icon="${iconName}" width="28" style="color:#333;"></iconify-icon><span class="text-[9px] text-gray-500 truncate w-full text-center">${iconName}</span>`;
          btn.addEventListener('click', ()=>{
            applyIconToModel(iconName);
            closeIconifyPicker();
          });
          results.appendChild(btn);
        });
      }

      function applyIconToModel(iconName){
        if(iconifyPickerState.model && window.editor){
           const m = iconifyPickerState.model;
           if(typeof m.addAttributes === 'function') {
               m.addAttributes({ icon: iconName });
               m.view.render();
           }
        }
      }

      const doSearch = debounce(async (q) => {
        const list = await searchIconify(q.trim());
        renderResults(list);
      }, 300);

      input.addEventListener('input', (e)=> doSearch(e.target.value));
      closeBtn.addEventListener('click', closeIconifyPicker);
      clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); });
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeIconifyPicker(); });

      const initInterval = setInterval(()=>{
        if(window.editor){
            window.editor.on('component:dblclick', (model) => {
                const tag = model.get('tagName');
                if(tag === 'iconify-icon') openIconifyPicker(model);
            });
            clearInterval(initInterval);
        }
      }, 500);
    })();

    // --- 2. MAIN EDITOR APP ---
    function editorApp() {
        return {
            loading: false, showSettings: false, device: 'desktop', tab: 'blocks', mobileTab: 'blocks',
            notifications: [],
            page: { slug: '', title: '', product_type: 'physical', config: { variants:[], shipping:{weight:1000}, order_bump:{active:false, title:'', price:0, desc:''}, coupons:[], settings:{} } },
            cred: { provider: 'midtrans', data: '' },
            authPass: localStorage.getItem('admin_pass'),

            init() {
                const params = new URLSearchParams(window.location.search);
                this.page.slug = params.get('slug');
                if(!this.authPass) window.location.href='/login';
                this.initGrapes();
            },

            notify(title, msg, type='success') { const id=Date.now(); this.notifications.push({id, title, msg, type, show:true}); setTimeout(()=>{ const idx=this.notifications.findIndex(n=>n.id===id); if(idx>-1)this.notifications[idx].show=false; }, 3000); },
            setDevice(d) { this.device=d; window.editor.setDevice(d); },
            cmd(c) { window.editor.runCommand(c); },
            addVariant() { this.page.config.variants.push({id:Date.now(), name:'', price:0}) },
            async saveCreds() { try { await fetch('/api/admin/credentials', {method:'POST', headers:{'Authorization':this.authPass}, body:JSON.stringify({provider:this.cred.provider, data:JSON.parse(this.cred.data)})}); this.notify('Berhasil','Key tersimpan!'); } catch(e){ this.notify('Gagal','JSON Invalid','error'); } },
            async savePage() { this.loading=true; try { await fetch('/api/admin/pages', {method:'POST', headers:{'Authorization':this.authPass}, body:JSON.stringify({slug:this.page.slug, title:this.page.title, product_type:this.page.product_type, html:editor.getHtml(), css:editor.getCss(), product_config:this.page.config})}); this.notify('Sukses','Halaman tersimpan!'); } catch(e){ this.notify('Error','Gagal simpan.','error'); } this.loading=false; },
            
            initGrapes() {
                setTimeout(() => {
                    window.editor = grapesjs.init({
                        container: '#gjs', height: '100%', fromElement: false, storageManager: false,
                        plugins: [
                            'gjs-blocks-basic', 'grapesjs-plugin-forms', 'grapesjs-navbar', 'grapesjs-component-countdown', 'grapesjs-tabs', 
                            'grapesjs-custom-code', 'grapesjs-tooltip', 'grapesjs-blocks-flexbox', 'grapesjs-plugin-export', 'grapesjs-typed', 'grapesjs-style-bg'
                        ],
                        pluginsOpts: { 'gjs-blocks-basic': { flexGrid: true } },
                        deviceManager: { devices: [{id:'desktop',width:''}, {id:'tablet',width:'768px'}, {id:'mobile',width:'375px'}] },
                        blockManager: { appendTo: '#blocks-container' },
                        layerManager: { appendTo: '#layers-container' },
                        selectorManager: { appendTo: '#selectors-container' },
                        traitManager: { appendTo: '#traits-container' },
                        styleManager: { 
                            appendTo: '#styles-container', 
                            sectors: [
                                { name: 'Typography', open: true, buildProps: ['font-family', 'font-size', 'font-weight', 'line-height', 'color', 'text-align'], properties: [{ property: 'color', type: 'color' }] }, 
                                { name: 'Dimensions', open: false, buildProps: ['width', 'height', 'padding', 'margin'] }, 
                                { name: 'Decorations', open: false, buildProps: ['background-color', 'border', 'border-radius', 'box-shadow'], properties: [{ property: 'background-color', type: 'color' }, { property: 'border-color', type: 'color' }] }
                            ] 
                        },
                        assetManager: { upload: false, autoAdd: true, uploadFile: async (e) => { /* Upload */ } }
                    });

                    // --- 3. COMPONENT DEFINITIONS (UNCHANGED) ---
                    const domc = editor.DomComponents;

                    domc.addType('cell', {
                        model: {
                            defaults: {
                                tagName: 'td',
                                draggable: false,
                                droppable: true,
                                editable: true,
                                components: { type: 'textnode', content: 'Cell' }
                            }
                        }
                    });

                    editor.Commands.add('table-add-row', editor => {
                        const selected = editor.getSelected();
                        const table = selected.closest('table');
                        if(table) {
                            const tbody = table.find('tbody')[0] || table;
                            const rows = tbody.find('tr');
                            if(rows.length>0) tbody.append(rows[rows.length-1].clone());
                            else tbody.append('<tr><td>New</td></tr>');
                        }
                    });
                    editor.Commands.add('table-add-col', editor => {
                        const selected = editor.getSelected();
                        const table = selected.closest('table');
                        if(table) {
                            table.find('tr').forEach(tr => tr.append('<td style="padding:10px; border:1px solid #ddd;">New</td>'));
                        }
                    });
                    editor.Commands.add('table-del-row', editor => {
                        const selected = editor.getSelected();
                        const row = selected.closest('tr');
                        if(row) row.remove();
                    });
                    editor.Commands.add('table-del-col', editor => {
                       const selected = editor.getSelected();
                       const table = selected.closest('table');
                       if(table) {
                           table.find('tr').forEach(tr => {
                               const cells = tr.find('td, th');
                               if(cells.length > 0) cells[cells.length-1].remove();
                           });
                       }
                    });

                    domc.addType('table', {
                        model: {
                            defaults: {
                                tagName: 'table',
                                traits: [
                                    { type: 'button', text: 'âž• Row', command: 'table-add-row' },
                                    { type: 'button', text: 'âž• Col', command: 'table-add-col' },
                                    { type: 'button', text: 'âž– Row', command: 'table-del-row' },
                                    { type: 'button', text: 'âž– Col', command: 'table-del-col' }
                                ]
                            }
                        }
                    });

                    domc.addType('iconify-icon', {
                        model: {
                            defaults: {
                                tagName: 'iconify-icon',
                                droppable: false,
                                attributes: { icon: 'mdi:home', width: '48', style: 'color:#2563eb' },
                                traits: [
                                    { type: 'button', text: 'ðŸ” Pilih Icon', full: true, command: (editor, trait) => window.openIconifyPicker(trait.target) },
                                    { name: 'width', type: 'number', label: 'Size' },
                                    { name: 'color', type: 'color', label: 'Color' }
                                ]
                            }
                        }
                    });

                    // --- 4. BLOCKS ---
                    const bm = editor.BlockManager;
                    bm.add('container-fluid', { label: 'Container', category: 'Layout', content: `<div style="width:90%; max-width:1200px; margin:0 auto; padding:20px; min-height:50px;"></div>` });
                    bm.add('section-std', { label: 'Section', category: 'Layout', content: `<section style="padding:60px 20px; background-color:#fff;"><div style="width:90%; max-width:1100px; margin:0 auto; padding:0 20px;"></div></section>` });
                    
                    bm.add('iconify-blk', { label: 'Iconify', category: 'Media', attributes: { class: 'ph ph-star' }, content: { type: 'iconify-icon' } });
                    bm.add('header-1', { label: 'Header Center', category: 'Headers', content: `<header style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:center;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /></header>` });
                    bm.add('header-2', { label: 'Header Left', category: 'Headers', content: `<header style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /><nav><a href="#" style="margin-left:15px;">Home</a></nav></header>` });
                    bm.add('header-3', { label: 'Header Right', category: 'Headers', content: `<header style="padding:15px 20px; display:flex; flex-direction:row-reverse; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:40px;" /><nav><a href="#" style="margin-right:15px;">Home</a></nav></header>` });
                    bm.add('header-4', { label: 'Header Stack', category: 'Headers', content: `<header style="padding:20px; text-align:center; border-bottom:1px solid #eee;"><img src="https://via.placeholder.com/150x50?text=LOGO" style="height:50px; margin-bottom:15px;" /><nav><a href="#">Home</a></nav></header>` });
                    bm.add('hero-tpl', { label: 'Hero', category: 'Content', content: `<section style="padding:60px 20px; text-align:center; background:#f8fafc;"><h1 style="font-size:3rem; margin-bottom:20px;">Headline</h1><p>Subheadline.</p></section>` });
                    bm.add('hero-image', { label: 'Hero + Image', category: 'Content', attributes: { class: 'ph ph-image' }, content: `<section style="padding:60px 20px; background:#f8fafc;"><div style="max-width:1100px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:40px; align-items:center;"><div><h1 style="font-size:3rem; margin:0 0 20px 0; line-height:1.2;">Headline</h1><p style="font-size:18px; color:#64748b; margin:0;">Subheadline text here with image on the right side.</p></div><div><img src="https://via.placeholder.com/500x400" style="width:100%; height:auto; border-radius:8px; display:block;" /></div></div></section>` });
                    bm.add('pricelist-tpl', { label: 'Pricelist Cards', category: 'Content', attributes: { class: 'ph ph-tag' }, content: `<section style="padding:60px 20px; background:#f8fafc;"><div style="max-width:1100px; margin:0 auto; display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:30px;"><div style="padding:30px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; text-align:center;"><h3 style="font-size:20px; font-weight:700; margin:0 0 15px 0;">Basic Plan</h3><p style="font-size:32px; font-weight:700; color:#2563eb; margin:10px 0;">Rp 99.000</p><p style="font-size:14px; color:#64748b; margin:15px 0;">Per bulan</p><ul style="list-style:none; padding:0; margin:20px 0; text-align:left;"><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature A</li><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature B</li><li style="padding:8px 0;">âœ— Feature C</li></ul><button style="width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Pilih Plan</button></div><div style="padding:30px; border:2px solid #2563eb; background:#fff; border-radius:8px; text-align:center; transform:scale(1.05);"><div style="display:inline-block; background:#2563eb; color:#fff; padding:5px 15px; border-radius:20px; font-size:12px; font-weight:700; margin-bottom:15px;">POPULER</div><h3 style="font-size:20px; font-weight:700; margin:10px 0 15px 0;">Pro Plan</h3><p style="font-size:32px; font-weight:700; color:#2563eb; margin:10px 0;">Rp 199.000</p><p style="font-size:14px; color:#64748b; margin:15px 0;">Per bulan</p><ul style="list-style:none; padding:0; margin:20px 0; text-align:left;"><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature A</li><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature B</li><li style="padding:8px 0;">âœ“ Feature C</li></ul><button style="width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Pilih Plan</button></div><div style="padding:30px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; text-align:center;"><h3 style="font-size:20px; font-weight:700; margin:0 0 15px 0;">Enterprise</h3><p style="font-size:32px; font-weight:700; color:#2563eb; margin:10px 0;">Custom</p><p style="font-size:14px; color:#64748b; margin:15px 0;">Hubungi kami</p><ul style="list-style:none; padding:0; margin:20px 0; text-align:left;"><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature A</li><li style="padding:8px 0; border-bottom:1px solid #e2e8f0;">âœ“ Feature B</li><li style="padding:8px 0;">âœ“ Feature C</li></ul><button style="width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Hubungi Sales</button></div></div></section>` });
                    bm.add('video-yt', { label: 'YouTube', category: 'Media', content: { type: 'video', provider: 'yt', style: { height: '350px', width: '100%' } } });
                    bm.add('checkout-pro', { label: 'Checkout', category: 'E-Commerce', content: `<div data-gjs-type="checkout-widget" style="padding:20px; border:2px dashed #3b82f6; text-align:center;"><strong>[ CHECKOUT ]</strong></div>` });

                    editor.on('load', () => {
                        editor.Canvas.getBody().style.backgroundColor = '#ffffff';
                        if(this.page.slug) {
                            fetch('/api/admin/pages/'+this.page.slug).then(r=>r.json()).then(d=>{
                                if(d.id) {
                                    this.page.title=d.title; this.page.product_type=d.product_type||'physical';
                                    try{ const c=JSON.parse(d.product_config_json||'{}'); this.page.config={variants:c.variants||[], shipping:c.shipping||{weight:1000}, order_bump:c.order_bump||{active:false,title:'',price:0,desc:''}, coupons:c.coupons||[], settings:c.settings||{}}; }catch(e){this.page.config={variants:[],shipping:{weight:1000},order_bump:{active:false},coupons:[],settings:{}};}
                                    if(d.html_content) editor.setComponents(d.html_content);
                                    if(d.css_content) editor.setStyle(d.css_content);
                                }
                            });
                        }
                    });
                }, 100);
            }
        }
    }
    </script>
</body>
</html>
